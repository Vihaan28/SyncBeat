<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>SyncBeat</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Syne:wght@700;800&display=swap" rel="stylesheet">
<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
:root{
  --bg:#080c10;--s1:#0f1419;--s2:#161d26;--br:#1e2a38;
  --ac:#00e5ff;--ac2:#7c3aed;--gr:#10b981;--yw:#f59e0b;--rd:#ef4444;
  --tx:#e8f0fe;--t2:#8899aa;--t3:#3d5166;
}
html,body{height:100%;background:var(--bg);color:var(--tx);font-family:'Syne',sans-serif;}
body{display:flex;flex-direction:column;max-width:430px;margin:0 auto;min-height:100dvh;}

/* HEADER */
.hdr{
  padding:13px 20px;display:flex;align-items:center;justify-content:space-between;
  background:var(--bg);border-bottom:1px solid var(--br);flex-shrink:0;
  position:relative;z-index:10;
}
.logo{display:flex;align-items:center;gap:8px;}
.logo-ic{width:30px;height:30px;background:linear-gradient(135deg,var(--ac),var(--ac2));border-radius:8px;display:flex;align-items:center;justify-content:center;}
.logo-tx{font-size:18px;font-weight:800;background:linear-gradient(90deg,var(--tx),var(--ac));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.pill{display:flex;align-items:center;gap:6px;background:var(--s1);border:1px solid var(--br);border-radius:20px;padding:5px 10px;font-family:'DM Mono',monospace;font-size:10px;color:var(--t2);}
.dot{width:7px;height:7px;border-radius:50%;background:var(--t3);flex-shrink:0;}
.dot.on{background:var(--gr);box-shadow:0 0 6px var(--gr);animation:blink 2s infinite;}
.dot.host{background:var(--ac);box-shadow:0 0 6px var(--ac);animation:blink 2s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.4}}

/* PAGES */
.pg{display:none;flex-direction:column;flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;position:relative;}
.pg.on{display:flex;}

/* ===== HOME ===== */
.home{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:28px 20px;gap:22px;text-align:center;position:relative;}
.rings{position:relative;width:130px;height:130px;pointer-events:none;overflow:visible;}
.ring{position:absolute;border-radius:50%;border:1px solid rgba(0,229,255,.18);animation:exp 3s ease-out infinite;top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:none;}
.ring:nth-child(1){width:65px;height:65px;animation-delay:0s}
.ring:nth-child(2){width:100px;height:100px;animation-delay:.8s}
.ring:nth-child(3){width:130px;height:130px;animation-delay:1.6s}
@keyframes exp{0%{opacity:.7}100%{opacity:0;transform:translate(-50%,-50%) scale(1.2)}}
.cic{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,var(--ac),var(--ac2));display:flex;align-items:center;justify-content:center;box-shadow:0 0 28px rgba(0,229,255,.3);pointer-events:none;}
.htitle{font-size:21px;font-weight:800;}
.hsub{font-size:12px;color:var(--t2);line-height:1.5;max-width:270px;margin-top:5px;}
.ibox{background:var(--s1);border:1px solid rgba(0,229,255,.2);border-radius:12px;padding:13px 16px;font-size:12px;color:var(--t2);line-height:1.6;width:100%;text-align:left;}
.ibox b{color:var(--ac);}
.bstack{display:flex;flex-direction:column;gap:10px;width:100%;position:relative;z-index:10;}

/* BUTTONS ‚Äî simple, reliable */
.btn{
  display:block;width:100%;padding:16px;border-radius:13px;
  font-family:'Syne',sans-serif;font-size:15px;font-weight:800;
  border:none;cursor:pointer;text-align:center;
  touch-action:manipulation;
  -webkit-tap-highlight-color:transparent;
  transition:opacity .15s, transform .1s;
  position:relative;z-index:1;
}
.btn:active{opacity:.8;transform:scale(.98);}
.btn:disabled{opacity:.5;cursor:not-allowed;}
.btn.p{background:var(--ac);color:#000;}
.btn.s{background:var(--s2);color:var(--tx);border:1px solid var(--br);}
.btn.g{background:var(--gr);color:#000;}
.btn.sm{padding:9px 14px;font-size:12px;border-radius:9px;width:auto;}
.btn.red{background:transparent;color:var(--t2);border:1px solid var(--br);}

/* ===== JOIN ===== */
.fwrap{padding:22px 20px;display:flex;flex-direction:column;gap:16px;}
.ftitle{font-size:20px;font-weight:800;}
.fsub{font-size:12px;color:var(--t2);line-height:1.5;margin-top:4px;}
.lbl{font-family:'DM Mono',monospace;font-size:10px;text-transform:uppercase;letter-spacing:2px;color:var(--t3);margin-bottom:7px;display:block;}
.inp{width:100%;padding:14px 16px;background:var(--s1);border:1px solid var(--br);border-radius:10px;color:var(--tx);outline:none;font-family:'DM Mono',monospace;font-size:15px;transition:border-color .2s;}
.inp:focus{border-color:var(--ac);}
.inp.code{font-size:24px;letter-spacing:8px;text-transform:uppercase;text-align:center;}
.smsg{font-family:'DM Mono',monospace;font-size:11px;color:var(--gr);text-align:center;min-height:16px;}

/* ===== HOST ===== */
.hwrap{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding-bottom:12px;}
.sec{padding:0 20px;margin-bottom:14px;}
.shdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:9px;}
.slbl{font-family:'DM Mono',monospace;font-size:10px;text-transform:uppercase;letter-spacing:2px;color:var(--t3);}
.badge{font-family:'DM Mono',monospace;font-size:10px;padding:3px 8px;border-radius:20px;background:var(--s2);color:var(--t2);border:1px solid var(--br);}
.badge.live{background:rgba(0,229,255,.1);color:var(--ac);border-color:rgba(0,229,255,.3);}
.ccard{background:var(--s1);border:1px solid var(--br);border-radius:14px;padding:16px 20px;text-align:center;}
.clbl{font-family:'DM Mono',monospace;font-size:10px;text-transform:uppercase;letter-spacing:2px;color:var(--t3);}
.cval{font-family:'DM Mono',monospace;font-size:32px;font-weight:500;letter-spacing:8px;color:var(--ac);display:block;margin:7px 0;}
.cbtns{display:flex;gap:8px;justify-content:center;margin-top:8px;}

/* TABS */
.tabs{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;padding:0 20px;margin-bottom:13px;}
.tab{
  padding:10px 6px;border-radius:9px;border:1px solid var(--br);background:var(--s1);
  color:var(--t2);font-family:'Syne',sans-serif;font-size:11px;font-weight:800;
  cursor:pointer;text-align:center;line-height:1.3;transition:all .15s;
  touch-action:manipulation;
}
.tab .ti{font-size:17px;display:block;margin-bottom:3px;}
.tab.on{border-color:var(--ac);color:var(--ac);background:rgba(0,229,255,.07);}
.tab:active{transform:scale(.97);}
.pan{display:none;}
.pan.on{display:block;}

/* UPLOAD */
.ubox{margin:0 20px 13px;border:2px dashed var(--br);border-radius:12px;padding:26px 20px;text-align:center;cursor:pointer;transition:all .2s;position:relative;}
.ubox:hover,.ubox.drag{border-color:var(--ac);background:rgba(0,229,255,.03);}
.ubox input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
.ubox p{font-size:12px;color:var(--t2);margin-top:5px;}
.flist{padding:0 20px;display:flex;flex-direction:column;gap:7px;margin-bottom:13px;}
.frow{background:var(--s1);border:1px solid var(--br);border-radius:8px;padding:10px 13px;display:flex;align-items:center;gap:9px;cursor:pointer;transition:all .15s;}
.frow:hover,.frow.on{border-color:rgba(0,229,255,.3);background:rgba(0,229,255,.04);}
.fnm{flex:1;font-size:12px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

/* YT */
.ytbox{margin:0 20px 13px;background:var(--s1);border:1px solid var(--br);border-radius:13px;overflow:hidden;}
.yttop{padding:11px;border-bottom:1px solid var(--br);display:flex;gap:8px;}
.ytinp{flex:1;padding:9px 11px;background:var(--s2);border:1px solid var(--br);border-radius:7px;color:var(--tx);font-family:'DM Mono',monospace;font-size:13px;outline:none;}
.ytinp:focus{border-color:var(--ac);}
.ytsb{padding:9px 13px;background:#ff0000;border:none;border-radius:7px;color:#fff;font-family:'Syne',sans-serif;font-weight:800;font-size:13px;cursor:pointer;touch-action:manipulation;}
.ytsb:active{opacity:.8;}
.ytchips{padding:7px 11px;display:flex;gap:6px;flex-wrap:wrap;border-bottom:1px solid var(--br);}
.chip{padding:5px 9px;border-radius:20px;background:var(--s2);border:1px solid var(--br);color:var(--t2);font-size:10px;font-family:'Syne',sans-serif;font-weight:800;cursor:pointer;transition:all .15s;touch-action:manipulation;}
.chip:hover{border-color:#ff0000;color:#ff0000;}
.chip:active{transform:scale(.96);}
.ytload{padding:14px;text-align:center;font-size:12px;color:var(--t2);font-family:'DM Mono',monospace;display:none;}
.ytload.on{display:block;}
.ytres{max-height:190px;overflow-y:auto;display:none;}
.ytres.on{display:block;}
.ytitem{display:flex;gap:9px;align-items:center;padding:8px 11px;cursor:pointer;border-bottom:1px solid var(--br);transition:background .1s;touch-action:manipulation;}
.ytitem:hover{background:var(--s2);}
.ytitem:last-child{border-bottom:none;}
.ytthumb{width:54px;height:40px;border-radius:5px;object-fit:cover;background:var(--s2);flex-shrink:0;}
.ytt{font-size:12px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ytch{font-size:10px;color:var(--t2);font-family:'DM Mono',monospace;margin-top:1px;}
.ytframe{display:none;}
.ytframe.on{display:block;}
.ytframe iframe{width:100%;aspect-ratio:16/9;border:none;display:block;}
.ytbar{padding:10px 11px;display:flex;align-items:center;gap:8px;border-top:1px solid var(--br);}
.ytst{flex:1;font-size:11px;color:var(--t2);font-family:'DM Mono',monospace;}
.ytst.on{color:var(--gr);}

/* CAPTURE */
.capbox{margin:0 20px 13px;background:var(--s1);border:1px solid var(--br);border-radius:13px;padding:16px;}
.capst{display:flex;align-items:center;gap:8px;background:var(--s2);border:1px solid var(--br);border-radius:8px;padding:9px 11px;margin-bottom:11px;font-family:'DM Mono',monospace;font-size:11px;color:var(--t2);}
.capst.on{border-color:rgba(16,185,129,.3);background:rgba(16,185,129,.05);color:var(--gr);}
.capbtns{display:flex;gap:8px;}

/* VOLUME */
.vcard{background:var(--s1);border:1px solid var(--br);border-radius:11px;padding:13px;}
.vhdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:9px;}
.vtitle{font-size:11px;font-weight:700;color:var(--t2);letter-spacing:.5px;}
.vrow{display:flex;align-items:center;gap:7px;}
.vic{color:var(--t3);flex-shrink:0;}
input[type=range]{flex:1;-webkit-appearance:none;appearance:none;height:4px;border-radius:2px;background:var(--br);outline:none;cursor:pointer;}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:17px;height:17px;border-radius:50%;background:var(--ac);box-shadow:0 0 7px rgba(0,229,255,.5);cursor:pointer;}
.vval{font-family:'DM Mono',monospace;font-size:11px;color:var(--t2);width:24px;text-align:right;flex-shrink:0;}
.mutic{width:27px;height:27px;border-radius:6px;background:var(--s2);border:1px solid var(--br);display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;transition:all .15s;touch-action:manipulation;}
.mutic:active{transform:scale(.9);}
.mutic.on{background:rgba(239,68,68,.15);border-color:rgba(239,68,68,.3);}

/* SPEAKERS */
.spklist{display:flex;flex-direction:column;gap:9px;padding:0 20px;margin-bottom:14px;}
.spkcard{background:var(--s1);border:1px solid var(--br);border-radius:11px;padding:12px;}
.spkcard.me{border-color:rgba(16,185,129,.3);background:rgba(16,185,129,.03);}
.spkcard.cl{border-color:rgba(0,229,255,.2);background:rgba(0,229,255,.03);}
.spktop{display:flex;align-items:center;gap:9px;margin-bottom:10px;}
.spkic{width:34px;height:34px;border-radius:8px;flex-shrink:0;display:flex;align-items:center;justify-content:center;}
.spkic.g{background:rgba(16,185,129,.12);}
.spkic.b{background:rgba(0,229,255,.12);}
.spkic.p{background:rgba(124,58,237,.12);}
.spknm{font-size:13px;font-weight:700;}
.spksub{font-size:10px;color:var(--t2);margin-top:1px;font-family:'DM Mono',monospace;}
.spkdot{width:7px;height:7px;border-radius:50%;flex-shrink:0;margin-left:auto;}
.spkdot.ok{background:var(--gr);box-shadow:0 0 5px var(--gr);}

/* PLAYER */
.player{flex-shrink:0;padding:11px 20px;padding-bottom:calc(11px + env(safe-area-inset-bottom));background:var(--s1);border-top:1px solid var(--br);}
.np{display:flex;align-items:center;gap:10px;margin-bottom:9px;}
.art{width:40px;height:40px;border-radius:8px;background:var(--s2);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:17px;position:relative;overflow:hidden;}
.art.on::after{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(0,229,255,.1),rgba(124,58,237,.1));animation:ap 2s ease-in-out infinite;}
@keyframes ap{0%,100%{opacity:.5}50%{opacity:1}}
.npi{flex:1;min-width:0;}
.npt{font-size:13px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.nps{font-size:11px;color:var(--t2);margin-top:2px;display:flex;align-items:center;gap:4px;}
.sdot{width:5px;height:5px;border-radius:50%;flex-shrink:0;}
.waves{display:flex;align-items:center;gap:2px;height:18px;}
.wv{width:3px;background:var(--ac);border-radius:2px;animation:wv 1.2s ease-in-out infinite;}
.wv:nth-child(1){height:6px;animation-delay:0s}
.wv:nth-child(2){height:13px;animation-delay:.2s}
.wv:nth-child(3){height:9px;animation-delay:.4s}
.wv:nth-child(4){height:17px;animation-delay:.1s}
.wv:nth-child(5){height:8px;animation-delay:.3s}
@keyframes wv{0%,100%{transform:scaleY(.4);opacity:.5}50%{transform:scaleY(1);opacity:1}}
.waves.off .wv{animation:none;transform:scaleY(.3);opacity:.3;}
.prog{position:relative;height:3px;background:var(--br);border-radius:2px;margin-bottom:9px;cursor:pointer;}
.pf{position:absolute;left:0;top:0;bottom:0;background:var(--ac);border-radius:2px;}
.pt{position:absolute;top:50%;transform:translateY(-50%);width:10px;height:10px;border-radius:50%;background:var(--ac);box-shadow:0 0 6px rgba(0,229,255,.5);margin-left:-5px;}
.tport{display:flex;align-items:center;justify-content:space-between;}
.tbtn{width:38px;height:38px;border-radius:50%;background:transparent;border:none;color:var(--t2);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .15s;touch-action:manipulation;}
.tbtn:active{color:var(--tx);transform:scale(.9);}
.ppbtn{width:46px;height:46px;border-radius:50%;background:var(--ac);border:none;color:#000;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 0 14px rgba(0,229,255,.4);transition:all .15s;flex-shrink:0;touch-action:manipulation;}
.ppbtn:active{transform:scale(.93);}

/* CLIENT */
.cwrap{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:16px 20px 20px;display:flex;flex-direction:column;gap:13px;}
.ccard{background:var(--s1);border:1px solid var(--br);border-radius:12px;padding:14px;}

/* TOAST */
#toast{position:fixed;bottom:70px;left:50%;transform:translateX(-50%) translateY(8px);background:var(--s2);border:1px solid var(--br);color:var(--tx);padding:9px 17px;border-radius:30px;font-size:12px;font-family:'DM Mono',monospace;opacity:0;transition:all .25s;z-index:9999;pointer-events:none;white-space:nowrap;}
#toast.on{opacity:1;transform:translateX(-50%) translateY(0);}

::-webkit-scrollbar{width:2px;}
::-webkit-scrollbar-thumb{background:var(--br);border-radius:2px;}
@media(min-width:430px){body{border-left:1px solid var(--br);border-right:1px solid var(--br);}}
</style>
</head>
<body>
<div id="toast"></div>

<!-- HEADER -->
<div class="hdr">
  <div class="logo">
    <div class="logo-ic">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
    </div>
    <span class="logo-tx">SyncBeat</span>
  </div>
  <div class="pill"><div class="dot" id="sd"></div><span id="sl">offline</span></div>
</div>

<!-- ===== HOME ===== -->
<div class="pg on" id="pgHome">
  <div class="home">
    <div class="rings" style="pointer-events:none;user-select:none;">
      <div class="ring" style="pointer-events:none;"></div>
      <div class="ring" style="pointer-events:none;"></div>
      <div class="ring" style="pointer-events:none;"></div>
      <div class="cic" style="pointer-events:none;"><svg width="24" height="24" viewBox="0 0 24 24" fill="black"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg></div>
    </div>
    <div><div class="htitle">Multi-Speaker Sync</div><div class="hsub">Play music in sync across multiple Bluetooth speakers from one device.</div></div>
    <div class="ibox" style="pointer-events:none;user-select:none;"><b>How it works:</b> The <b>Host</b> plays music and shares a 6-digit code. Other devices <b>Join</b> with that code, each connecting their own Bluetooth speaker. Everything syncs over the internet.</div>
    <div class="bstack">
      <button class="btn p" id="btnHost" onclick="startHost()">üéµ Host Session</button>
      <button class="btn s" id="btnJoin" onclick="goJoin()">üì° Join Session</button>
    </div>
  </div>
</div>

<!-- ===== JOIN ===== -->
<div class="pg" id="pgJoin">
  <div class="fwrap">
    <div><div class="ftitle">Join a Session</div><div class="fsub">Enter the room code shown on the host's screen.</div></div>
    <div>
      <label class="lbl">Room Code</label>
      <input class="inp code" id="inCode" type="text" maxlength="6" placeholder="XXXXXX" autocomplete="off" autocorrect="off" spellcheck="false" oninput="this.value=this.value.toUpperCase().replace(/[^A-Z0-9]/g,'')">
    </div>
    <div>
      <label class="lbl">Speaker Name</label>
      <input class="inp" id="inName" type="text" maxlength="24" placeholder="e.g. Kitchen Speaker" autocomplete="off">
    </div>
    <div class="smsg" id="joinMsg"></div>
    <button class="btn p" id="btnConnect" onclick="doJoin()">Connect ‚Üí</button>
    <button class="btn s" onclick="goHome()">‚Üê Back</button>
  </div>
</div>

<!-- ===== HOST ===== -->
<div class="pg" id="pgHost">
  <div class="hwrap">

    <div class="sec" style="margin-top:15px">
      <div class="ccard">
        <div class="clbl">Room Code ‚Äî share this with others</div>
        <span class="cval" id="codeVal">------</span>
        <div id="p2pBadge" style="font-family:'DM Mono',monospace;font-size:10px;color:var(--t3);margin-bottom:9px">‚è≥ connecting...</div>
        <div class="cbtns">
          <button class="btn sm p" onclick="copyCode()">üìã Copy Code</button>
          <button class="btn sm red" onclick="endSession()">End Session</button>
        </div>
      </div>
    </div>

    <div class="sec"><div class="slbl">AUDIO SOURCE</div></div>
    <div class="tabs">
      <button class="tab on" id="tab0" onclick="setTab(0)"><span class="ti">üìÅ</span>My Files</button>
      <button class="tab" id="tab1" onclick="setTab(1)"><span class="ti">‚ñ∂Ô∏è</span>YouTube</button>
      <button class="tab" id="tab2" onclick="setTab(2)"><span class="ti">üéôÔ∏è</span>Capture</button>
    </div>

    <!-- Files -->
    <div class="pan on" id="pan0">
      <div class="ubox" id="dropBox">
        <input type="file" accept="audio/*" multiple id="fileIn" onchange="addFiles(event)">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="var(--t3)"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/></svg>
        <p>Tap to upload audio files</p>
        <p style="font-size:10px;color:var(--t3);margin-top:2px">MP3 ¬∑ WAV ¬∑ AAC ¬∑ FLAC</p>
      </div>
      <div class="flist" id="fileList"></div>
    </div>

    <!-- YouTube -->
    <div class="pan" id="pan1">
      <div class="ytbox">
        <div class="yttop">
          <input class="ytinp" id="ytQ" type="text" placeholder="Search YouTube Music..." onkeydown="if(event.key==='Enter')ytSearch()" autocomplete="off" autocorrect="off" spellcheck="false">
          <button class="ytsb" onclick="ytSearch()">‚ñ∂</button>
        </div>
        <div class="ytchips">
          <button class="chip" onclick="ytQ.value='top hits 2024';ytSearch()">üî• Top Hits</button>
          <button class="chip" onclick="ytQ.value='lo-fi chill music';ytSearch()">üòå Lo-Fi</button>
          <button class="chip" onclick="ytQ.value='hip hop playlist';ytSearch()">üé§ Hip Hop</button>
          <button class="chip" onclick="ytQ.value='pop music 2024';ytSearch()">üéµ Pop</button>
          <button class="chip" onclick="ytQ.value='workout music';ytSearch()">üí™ Workout</button>
          <button class="chip" onclick="ytQ.value='jazz playlist';ytSearch()">üé∑ Jazz</button>
        </div>
        <div class="ytload" id="ytLoad">Searching...</div>
        <div class="ytres" id="ytRes"></div>
        <div class="ytframe" id="ytFrame"><iframe id="ytIframe" allow="autoplay;encrypted-media" allowfullscreen></iframe></div>
        <div class="ytbar">
          <div class="ytst" id="ytCapSt">Tap Capture to sync speakers</div>
          <button class="btn sm g" id="ytCapBtn" onclick="startYtCap()">üéôÔ∏è Capture</button>
          <button class="btn sm red" id="ytStopBtn" style="display:none" onclick="stopYtCap()">‚èπ Stop</button>
        </div>
      </div>
      <div class="sec" style="margin-top:2px"><div style="background:var(--s1);border:1px solid var(--br);border-radius:9px;padding:11px;font-size:11px;color:var(--t3);line-height:1.5">üí° For <b style="color:var(--t2)">Spotify / Apple Music</b> use the Capture tab. YouTube works here natively ‚Äî minimal screen share on Chrome.</div></div>
    </div>

    <!-- Capture -->
    <div class="pan" id="pan2">
      <div class="capbox">
        <div style="font-size:26px;margin-bottom:9px">üéôÔ∏è</div>
        <div style="font-size:14px;font-weight:800;margin-bottom:5px">System Audio Capture</div>
        <div style="font-size:12px;color:var(--t2);line-height:1.5;margin-bottom:13px">Capture audio from any app ‚Äî Spotify, Apple Music, YouTube, anything. All speakers receive it in sync.</div>
        <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:13px">
          <div style="display:flex;gap:9px"><div style="width:19px;height:19px;border-radius:50%;background:rgba(0,229,255,.12);border:1px solid rgba(0,229,255,.3);display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:800;color:var(--ac);flex-shrink:0">1</div><div style="font-size:12px;color:var(--t2)">Click <b style="color:var(--tx)">Start Capture</b> below</div></div>
          <div style="display:flex;gap:9px"><div style="width:19px;height:19px;border-radius:50%;background:rgba(0,229,255,.12);border:1px solid rgba(0,229,255,.3);display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:800;color:var(--ac);flex-shrink:0">2</div><div style="font-size:12px;color:var(--t2)">Select screen/window and check <b style="color:var(--tx)">"Share system audio"</b></div></div>
          <div style="display:flex;gap:9px"><div style="width:19px;height:19px;border-radius:50%;background:rgba(0,229,255,.12);border:1px solid rgba(0,229,255,.3);display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:800;color:var(--ac);flex-shrink:0">3</div><div style="font-size:12px;color:var(--t2)">Play music in any app ‚Äî all speakers sync automatically</div></div>
        </div>
        <div class="capst" id="capSt"><div class="dot"></div><span>Not capturing</span></div>
        <div class="capbtns">
          <button class="btn p" id="capBtn" onclick="startCap()" style="flex:1">üéôÔ∏è Start Capture</button>
          <button class="btn s" id="capStop" onclick="stopCap()" style="flex:none;padding:14px 16px;display:none">‚èπ</button>
        </div>
      </div>
    </div>

    <!-- Global Volume -->
    <div class="sec">
      <div class="shdr"><span class="slbl">MASTER VOLUME</span><span class="badge live" id="syncCnt">0 synced</span></div>
      <div class="vcard">
        <div class="vhdr"><span class="vtitle">ALL SPEAKERS</span><span id="muteLbl" style="font-family:'DM Mono',monospace;font-size:10px;color:var(--rd)"></span></div>
        <div class="vrow">
          <svg class="vic" width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>
          <input type="range" min="0" max="100" value="80" id="gVol" oninput="setGVol(this.value)">
          <span class="vval" id="gVolV">80</span>
          <div class="mutic" id="gMute" onclick="toggleMute()"><svg width="12" height="12" viewBox="0 0 24 24" fill="var(--t2)"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg></div>
        </div>
      </div>
    </div>

    <!-- Speakers -->
    <div class="sec"><div class="shdr"><span class="slbl">CONNECTED SPEAKERS</span><span class="badge live" id="spkCnt">0 online</span></div></div>
    <div class="spklist" id="spkList">
      <div class="spkcard me">
        <div class="spktop">
          <div class="spkic g"><svg width="15" height="15" viewBox="0 0 24 24" fill="var(--gr)"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14.5v-9l6 4.5-6 4.5z"/></svg></div>
          <div><div class="spknm">This Device (Host)</div><div class="spksub">HOST ¬∑ MASTER</div></div>
          <div class="spkdot ok"></div>
        </div>
        <div class="vrow">
          <svg class="vic" width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>
          <input type="range" min="0" max="100" value="80" oninput="setSpkVol('host',this.value,this)">
          <span class="vval" id="vhost">80</span>
          <div class="mutic" onclick="muteSpk('host',this)"><svg width="11" height="11" viewBox="0 0 24 24" fill="var(--t2)"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg></div>
        </div>
      </div>
    </div>

  </div><!-- hwrap -->

  <!-- Player -->
  <div class="player">
    <div class="np">
      <div class="art" id="artEl"><svg width="15" height="15" viewBox="0 0 24 24" fill="var(--t3)"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg></div>
      <div class="npi">
        <div class="npt" id="npTitle">No source selected</div>
        <div class="nps"><div class="sdot" id="srcDot" style="background:var(--t3)"></div><span id="srcLbl">Choose a source above</span></div>
      </div>
      <div class="waves off" id="waves"><div class="wv"></div><div class="wv"></div><div class="wv"></div><div class="wv"></div><div class="wv"></div></div>
    </div>
    <div class="prog" id="progBar" onclick="seekTo(event)"><div class="pf" id="pf" style="width:0%"></div><div class="pt" id="pt" style="left:0%"></div></div>
    <div class="tport">
      <button class="tbtn" onclick="prevTrk()"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg></button>
      <button class="ppbtn" id="ppBtn" onclick="togglePlay()"><svg id="ppIco" width="21" height="21" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg></button>
      <button class="tbtn" onclick="nextTrk()"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg></button>
    </div>
  </div>
</div>

<!-- ===== CLIENT ===== -->
<div class="pg" id="pgClient">
  <div class="cwrap">
    <div class="ccard" style="border-color:rgba(0,229,255,.2)">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div>
          <div style="font-family:'DM Mono',monospace;font-size:10px;text-transform:uppercase;letter-spacing:2px;color:var(--t3)">Connected Room</div>
          <div style="font-family:'DM Mono',monospace;font-size:22px;letter-spacing:6px;color:var(--ac);margin-top:4px" id="clCode">------</div>
        </div>
        <div style="text-align:right">
          <div class="dot on" style="width:10px;height:10px;margin-left:auto;margin-bottom:4px"></div>
          <div style="font-family:'DM Mono',monospace;font-size:10px;color:var(--gr)" id="clLat">-- ms</div>
        </div>
      </div>
    </div>
    <div class="ccard" style="font-size:12px;color:var(--t2);line-height:1.6;border-color:rgba(0,229,255,.15)">
      This device is a <b style="color:var(--ac)">Speaker</b>. Connect your Bluetooth speaker to this device. Audio plays automatically when the host streams.
    </div>
    <div>
      <div class="slbl" style="margin-bottom:8px">MY SPEAKER VOLUME</div>
      <div class="vcard">
        <div class="vhdr"><span class="vtitle" id="clName">Speaker</span><span style="font-family:'DM Mono',monospace;font-size:10px;color:var(--gr)">Local</span></div>
        <div class="vrow">
          <svg class="vic" width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>
          <input type="range" min="0" max="100" value="80" id="clVol" oninput="setClVol(this.value)">
          <span class="vval" id="clVolV">80</span>
        </div>
      </div>
    </div>
    <div>
      <div class="slbl" style="margin-bottom:8px">NOW PLAYING</div>
      <div class="ccard">
        <div style="display:flex;align-items:center;gap:10px">
          <div class="art on" id="clArt" style="flex-shrink:0"><svg width="15" height="15" viewBox="0 0 24 24" fill="var(--t3)"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg></div>
          <div style="flex:1;min-width:0">
            <div class="npt" id="clTitle">Waiting for host...</div>
            <div class="nps" style="margin-top:2px"><div class="sdot" id="clSrcDot" style="background:var(--t3)"></div><span id="clSt">Idle</span></div>
          </div>
          <div class="waves off" id="clWaves"><div class="wv"></div><div class="wv"></div><div class="wv"></div><div class="wv"></div><div class="wv"></div></div>
        </div>
      </div>
    </div>
    <button class="btn s" onclick="leaveSession()" style="margin-top:auto">Disconnect</button>
  </div>
</div>

<audio id="aud" preload="auto"></audio>

<script>
const A={mode:null,code:null,playing:false,ti:-1,tracks:[],spks:{},gv:80,gm:false,hv:80,eng:null,actx:null,gain:null,cs:null,cx:null};
const aud=document.getElementById('aud');

/* ENGINE */
class Engine{
  constructor(){this.isHost=false;this.code=null;this.H={};this.id='sb'+Math.random().toString(36).substr(2,9);this.peer=null;this.hc=null;this.clients=new Map();this.bc=null;this.T=[];}
  gc(){const c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';return Array.from({length:6},()=>c[Math.floor(Math.random()*c.length)]).join('');}
  async host(){
    this.isHost=true;this.code=this.gc();this._bc();
    const ok=await this._peer('sb-host-'+this.code);
    if(ok&&this.peer){
      this.peer.on('connection',c=>{c.on('open',()=>{this.clients.set(c.peer,c);c.on('data',d=>this._rx(d,c.peer));c.on('close',()=>{this.clients.delete(c.peer);this._gone(c.peer);});});});
      this._badge(true);
    }else{this._badge(false);}
    return this.code;
  }
  async join(code,name){
    this.isHost=false;this.code=code;this._bc();setJMsg('Connecting...');
    const ok=await this._peer(this.id);
    if(!ok){setJMsg('P2P unavailable');this._bcs({type:'join',name,id:this.id});return{ok:true};}
    return new Promise((res,rej)=>{
      setJMsg('Looking up host...');
      let conn;
      try{conn=this.peer.connect('sb-host-'+code,{reliable:true,serialization:'json'});this.hc=conn;}
      catch(e){rej(new Error('Failed to connect'));return;}
      const t=setTimeout(()=>rej(new Error('Host not found. Check code is correct.')),14000);
      conn.on('open',()=>{
        clearTimeout(t);setJMsg('Connected ‚úì');
        conn.on('data',d=>this._rx(d,'host'));
        conn.on('close',()=>{toast('Disconnected');setStatus('','offline');});
        this._tx({type:'join',name,id:this.id});this._clock();res({ok:true});
      });
      conn.on('error',err=>{clearTimeout(t);rej(new Error(err.type==='peer-unavailable'?'Host not found. Check room code.':'Error: '+err.type));});
    });
  }
  _bc(){try{this.bc=new BroadcastChannel('sb_'+this.code);this.bc.onmessage=e=>this._rx(e.data,'bc');}catch(e){}}
  _bcs(d){if(this.bc)try{this.bc.postMessage({...d,_f:this.id,_r:this.code});}catch(e){}}
  _tx(d){const m={...d,_f:this.id};if(this.hc&&this.hc.open)try{this.hc.send(m);}catch(e){}this._bcs(m);}
  send(d){const m={...d,_f:this.id};if(this.isHost){this.clients.forEach(c=>{if(c.open)try{c.send(m);}catch(e){}});this._bcs(m);}else{this._tx(d);}}
  _rx(d,src){if(!d||d._f===this.id)return;if(d._r&&d._r!==this.code)return;if(this.isHost&&src!=='bc'){this.clients.forEach((c,p)=>{if(p!==src&&c.open)try{c.send(d);}catch(e){}});}const h=this.H[d.type];if(h)h(d);}
  _gone(pid){const el=document.getElementById('spk-'+pid);if(el){const nm=el.querySelector('.spknm')?.textContent||'Speaker';toast(nm+' disconnected');el.remove();delete A.spks[pid];updC();}}
  on(t,fn){this.H[t]=fn;}
  _clock(){this.on('pong',d=>{const el=document.getElementById('clLat');if(el)el.textContent=(Date.now()-d.t1)+'ms';});const t=setInterval(()=>this._tx({type:'ping',t1:Date.now()}),3000);this.T.push(t);this._tx({type:'ping',t1:Date.now()});}
  _peer(id){return new Promise(res=>{if(typeof Peer==='undefined'){res(false);return;}const done=(v)=>{clearTimeout(to);res(v);};const to=setTimeout(()=>{try{if(this.peer)this.peer.destroy();}catch(e){}this.peer=null;res(false);},7000);try{this.peer=new Peer(id,{host:'0.peerjs.com',port:443,path:'/',secure:true,debug:0,config:{iceServers:[{urls:'stun:stun.l.google.com:19302'},{urls:'stun:stun1.l.google.com:19302'}]}});this.peer.on('open',()=>done(true));this.peer.on('error',err=>{if(err.type==='unavailable-id'){done(true);return;}try{this.peer.destroy();}catch(e){}this.peer=null;done(false);});}catch(e){this.peer=null;done(false);}});}
  _badge(ok){const el=document.getElementById('p2pBadge');if(!el)return;el.textContent=ok?'üåê P2P Ready ‚Äî share code with phone':'‚ö† Local only (check internet)';el.style.color=ok?'var(--gr)':'var(--yw)';}
  destroy(){this.T.forEach(clearInterval);if(this.bc)try{this.bc.close();}catch(e){}if(this.hc)try{this.hc.close();}catch(e){}this.clients.forEach(c=>{try{c.close();}catch(e){}});if(this.peer)try{this.peer.destroy();}catch(e){};}
}

/* NAV */
function goPg(id){document.querySelectorAll('.pg').forEach(p=>p.classList.remove('on'));document.getElementById(id).classList.add('on');}
function goHome(){if(A.eng){A.eng.destroy();A.eng=null;}aud.pause();aud.src='';A.mode=null;A.playing=false;A.tracks=[];A.ti=-1;A.spks={};goPg('pgHome');setStatus('','offline');}
function goJoin(){goPg('pgJoin');setTimeout(()=>document.getElementById('inCode').focus(),100);}

/* HOST */
async function startHost(){
  const b=document.getElementById('btnHost');b.textContent='‚è≥ Starting...';b.disabled=true;
  try{
    A.eng=new Engine();A.mode='host';
    A.eng.on('join',d=>addSpk(d.id,d.name));
    A.eng.on('ping',d=>A.eng.send({type:'pong',t1:d.t1}));
    A.eng.on('volChange',d=>{if(A.spks[d.id])A.spks[d.id].vol=d.vol;});
    const code=await A.eng.host();
    A.code=code;document.getElementById('codeVal').textContent=code;
    goPg('pgHost');setStatus('host','hosting');toast('‚úì Session started! Share your code');
  }catch(e){toast('Error: '+e.message);if(A.eng){A.eng.destroy();A.eng=null;}A.mode=null;}
  finally{b.textContent='üéµ Host Session';b.disabled=false;}
}

function addSpk(id,name){
  if(A.spks[id])return;
  A.spks[id]={name,vol:80,muted:false};
  const l=document.getElementById('spkList');
  const d=document.createElement('div');d.className='spkcard cl';d.id='spk-'+id;
  d.innerHTML=`<div class="spktop"><div class="spkic p"><svg width="14" height="14" viewBox="0 0 24 24" fill="var(--ac2)"><path d="M17 12h-5v5h5v-5zM16 1v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-1V1h-2z"/></svg></div><div><div class="spknm">${esc(name)}</div><div class="spksub">SPEAKER ¬∑ CLIENT</div></div><div class="spkdot ok"></div></div><div class="vrow"><svg class="vic" width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg><input type="range" min="0" max="100" value="80" oninput="setSpkVol('${id}',this.value,this)"><span class="vval" id="v${id}">80</span><div class="mutic" onclick="muteSpk('${id}',this)"><svg width="11" height="11" viewBox="0 0 24 24" fill="var(--t2)"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg></div></div>`;
  l.appendChild(d);updC();toast(name+' joined üîä');
  setTimeout(()=>A.eng.send({type:'state',trackName:A.tracks[A.ti]?.name.replace(/\.[^.]+$/,'')||'',isPlaying:A.playing,vol:A.gv}),400);
}

function updC(){const n=Object.keys(A.spks).length;document.getElementById('spkCnt').textContent=n+' online';document.getElementById('syncCnt').textContent=n+' synced';}

function endSession(){if(A.eng){A.eng.destroy();A.eng=null;}aud.pause();aud.src='';A.mode=null;A.playing=false;A.tracks=[];A.ti=-1;A.spks={};goPg('pgHome');setStatus('','offline');}
function copyCode(){navigator.clipboard.writeText(A.code||'').then(()=>toast('Copied!')).catch(()=>toast('Code: '+A.code));}

/* CLIENT */
async function doJoin(){
  const code=document.getElementById('inCode').value.trim();
  const name=document.getElementById('inName').value.trim()||'Speaker';
  if(code.length<4){toast('Enter a valid room code');return;}
  const b=document.getElementById('btnConnect');b.textContent='Connecting...';b.disabled=true;
  try{
    A.eng=new Engine();A.mode='client';
    A.eng.on('state',d=>{document.getElementById('clTitle').textContent=d.trackName||'Waiting...';if(d.isPlaying)setClPl(true);aud.volume=(d.vol||80)/100;});
    A.eng.on('play',d=>{if(d.src){aud.src=d.src;aud.load();}aud.currentTime=d.time||0;aud.volume=(d.vol||80)/100;aud.play().catch(()=>{toast('Tap screen to enable audio');document.addEventListener('click',()=>aud.play(),{once:true});});document.getElementById('clTitle').textContent=d.trackName||'Playing';document.getElementById('clSt').textContent=d.ch||'Playing';document.getElementById('clSrcDot').style.background='var(--ac)';setClPl(true);});
    A.eng.on('pause',()=>{aud.pause();setClPl(false);});
    A.eng.on('seek',d=>{aud.currentTime=d.time;});
    A.eng.on('volSet',d=>{if(d.tid===A.eng.id||d.tid==='all'){aud.volume=d.vol/100;document.getElementById('clVol').value=d.vol;document.getElementById('clVolV').textContent=d.vol;}});
    A.eng.on('captureStart',d=>{document.getElementById('clTitle').textContent=d.name||'System Audio';document.getElementById('clSt').textContent='Live ¬∑ synced';document.getElementById('clSrcDot').style.background='var(--gr)';document.getElementById('clArt').textContent=d.src==='yt'?'‚ñ∂Ô∏è':'üéôÔ∏è';setClPl(true);toast('Host started streaming');});
    A.eng.on('ytPlay',d=>{document.getElementById('clTitle').textContent=d.title||'YouTube';document.getElementById('clSt').textContent=d.ch||'YouTube';document.getElementById('clSrcDot').style.background='#ff0000';document.getElementById('clArt').textContent='‚ñ∂Ô∏è';});
    await A.eng.join(code,name);
    document.getElementById('clCode').textContent=code;document.getElementById('clName').textContent=name;
    goPg('pgClient');setStatus('on','synced');toast('Joined room '+code+' üéµ');
  }catch(e){
    if(A.eng){A.eng.destroy();A.eng=null;}A.mode=null;
    toast('‚úó '+e.message.split('\n')[0]);setJMsg('Failed: '+e.message.split('\n')[0]);
  }finally{b.textContent='Connect ‚Üí';b.disabled=false;}
}

function setClPl(on){document.getElementById('clWaves').classList.toggle('off',!on);document.getElementById('clArt').classList.toggle('on',on);if(!on)document.getElementById('clSt').textContent='Paused';}
function setClVol(v){document.getElementById('clVolV').textContent=v;aud.volume=v/100;if(A.eng)A.eng.send({type:'volChange',id:A.eng.id,vol:parseInt(v)});}
function leaveSession(){if(A.eng){A.eng.destroy();A.eng=null;}aud.pause();aud.src='';A.mode=null;goPg('pgHome');setStatus('','offline');}

/* TABS */
function setTab(n){for(let i=0;i<3;i++){document.getElementById('tab'+i).classList.toggle('on',i===n);document.getElementById('pan'+i).classList.toggle('on',i===n);}}

/* FILES */
function addFiles(e){const f=Array.from(e.target.files).filter(f=>f.type.startsWith('audio/'));f.forEach(x=>A.tracks.push({name:x.name,url:URL.createObjectURL(x)}));renderF();if(A.tracks.length&&A.ti===-1)loadT(0,false);toast(f.length+' track'+(f.length>1?'s':'')+' added');}
function renderF(){const l=document.getElementById('fileList');l.innerHTML='';A.tracks.forEach((t,i)=>{const d=document.createElement('div');d.className='frow'+(i===A.ti?' on':'');d.innerHTML=`<svg width="12" height="12" viewBox="0 0 24 24" fill="${i===A.ti?'var(--ac)':'var(--t3)'}"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg><span class="fnm">${esc(t.name.replace(/\.[^.]+$/,''))}</span>`;d.onclick=()=>loadT(i,true);l.appendChild(d);});}
function loadT(i,play){if(i<0||i>=A.tracks.length)return;A.ti=i;const t=A.tracks[i];aud.src=t.url;aud.volume=A.hv/100;const nm=t.name.replace(/\.[^.]+$/,'');setNP(nm,'Local File','var(--ac)','üéµ');renderF();if(play){aud.load();aud.play().then(onPlay).catch(console.warn);}}
function togglePlay(){if(A.cs||A.gain){toast('Use Capture controls');return;}if(!A.tracks.length){toast('Upload music first');return;}if(A.ti===-1){loadT(0,true);return;}if(aud.paused)aud.play().then(onPlay).catch(console.warn);else{aud.pause();onPause();}}
function onPlay(){A.playing=true;setPPIco(true);document.getElementById('waves').classList.remove('off');document.getElementById('artEl').classList.add('on');if(A.eng)A.eng.send({type:'play',src:null,time:aud.currentTime,trackName:A.tracks[A.ti]?.name.replace(/\.[^.]+$/,'')||'',vol:A.gv});}
function onPause(){A.playing=false;setPPIco(false);document.getElementById('waves').classList.add('off');document.getElementById('artEl').classList.remove('on');if(A.eng)A.eng.send({type:'pause'});}
function setPPIco(on){document.getElementById('ppIco').innerHTML=on?'<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>':'<path d="M8 5v14l11-7z"/>';}
function prevTrk(){if(A.tracks.length)loadT(A.ti>0?A.ti-1:A.tracks.length-1,A.playing);}
function nextTrk(){if(A.tracks.length)loadT((A.ti+1)%A.tracks.length,true);}
aud.addEventListener('ended',nextTrk);
aud.addEventListener('timeupdate',()=>{if(!aud.duration)return;const p=(aud.currentTime/aud.duration)*100;document.getElementById('pf').style.width=p+'%';document.getElementById('pt').style.left=p+'%';});
function seekTo(e){if(!aud.duration)return;const r=e.currentTarget.getBoundingClientRect();aud.currentTime=((e.clientX-r.left)/r.width)*aud.duration;if(A.eng)A.eng.send({type:'seek',time:aud.currentTime});}

/* VOLUME */
function setGVol(v){v=parseInt(v);A.gv=v;document.getElementById('gVolV').textContent=v;aud.volume=(A.hv/100)*(v/100);if(A.gain)A.gain.gain.value=(A.hv/100)*(v/100);if(A.eng)A.eng.send({type:'volSet',tid:'all',vol:v});}
function setSpkVol(id,v,el){v=parseInt(v);const ve=document.getElementById('v'+id);if(ve)ve.textContent=v;if(id==='host'){A.hv=v;aud.volume=(v/100)*(A.gv/100);if(A.gain)A.gain.gain.value=(v/100)*(A.gv/100);}else if(A.spks[id]){A.spks[id].vol=v;if(A.eng)A.eng.send({type:'volSet',tid:id,vol:v});}}
function toggleMute(){A.gm=!A.gm;document.getElementById('gMute').classList.toggle('on',A.gm);document.getElementById('muteLbl').textContent=A.gm?'MUTED':'';aud.muted=A.gm;if(A.gain)A.gain.gain.value=A.gm?0:(A.hv/100)*(A.gv/100);if(A.eng)A.eng.send({type:'volSet',tid:'all',vol:A.gm?0:A.gv});}
function muteSpk(id,el){if(id==='host'){aud.muted=!aud.muted;el.classList.toggle('on',aud.muted);}else if(A.spks[id]){A.spks[id].muted=!A.spks[id].muted;el.classList.toggle('on',A.spks[id].muted);if(A.eng)A.eng.send({type:'volSet',tid:id,vol:A.spks[id].muted?0:A.spks[id].vol});}}

/* YOUTUBE */
async function ytSearch(){const q=document.getElementById('ytQ').value.trim();if(!q)return;const ld=document.getElementById('ytLoad'),rs=document.getElementById('ytRes');ld.classList.add('on');rs.classList.remove('on');rs.innerHTML='';const insts=['https://iv.datura.network','https://invidious.slipfox.xyz','https://invidious.nerdvpn.de'];let data=null;for(const i of insts){try{const r=await fetch(`${i}/api/v1/search?q=${encodeURIComponent(q)}&type=video&fields=videoId,title,author,videoThumbnails`,{signal:AbortSignal.timeout(5000)});if(r.ok){data=await r.json();break;}}catch(e){continue;}}ld.classList.remove('on');if(!data||!data.length){rs.innerHTML=`<div style="padding:13px;font-size:12px;color:var(--t2)">Search unavailable. Paste a YouTube video ID:<div style="display:flex;gap:7px;margin-top:7px"><input id="ytDi" class="ytinp" style="flex:1" placeholder="Video ID (e.g. dQw4w9WgXcQ)"><button class="ytsb" onclick="ytDo()">‚ñ∂</button></div></div>`;rs.classList.add('on');return;}data.slice(0,8).forEach(v=>{const th=v.videoThumbnails?.[3]?.url||v.videoThumbnails?.[0]?.url||'';const d=document.createElement('div');d.className='ytitem';d.innerHTML=`<img class="ytthumb" src="${th}" onerror="this.style.display='none'"><div style="flex:1;min-width:0"><div class="ytt">${esc(v.title)}</div><div class="ytch">${esc(v.author||'')}</div></div><svg width="16" height="16" viewBox="0 0 24 24" fill="var(--ac2)"><path d="M8 5v14l11-7z"/></svg>`;d.onclick=()=>ytPlay(v.videoId,v.title,v.author);rs.appendChild(d);});rs.classList.add('on');}
function ytDo(){const v=document.getElementById('ytDi')?.value?.trim();if(!v)return;const m=v.match(/(?:v=|youtu\.be\/|embed\/)([\w-]{11})/);const id=m?m[1]:v;if(id.length===11)ytPlay(id,'YouTube Video','');else toast('Invalid video ID');}
function ytPlay(vid,title,ch){document.getElementById('ytRes').classList.remove('on');document.getElementById('ytIframe').src=`https://www.youtube-nocookie.com/embed/${vid}?autoplay=1&rel=0&modestbranding=1`;document.getElementById('ytFrame').classList.add('on');setNP(title||'YouTube Music',ch||'YouTube','#ff0000','‚ñ∂Ô∏è');A.playing=true;setPPIco(true);document.getElementById('waves').classList.remove('off');document.getElementById('artEl').classList.add('on');if(A.eng)A.eng.send({type:'ytPlay',videoId:vid,title,ch});toast('‚ñ∂ Playing ‚Äî tap Capture to sync');}
async function startYtCap(){if(!navigator.mediaDevices?.getDisplayMedia){toast('Not supported on this browser');return;}try{const s=await navigator.mediaDevices.getDisplayMedia({video:true,audio:{echoCancellation:false,noiseSuppression:false,sampleRate:44100},preferCurrentTab:true});const at=s.getAudioTracks();if(!at.length){s.getTracks().forEach(t=>t.stop());toast('No audio ‚Äî enable "Share tab audio"');return;}s.getVideoTracks().forEach(t=>t.stop());if(!A.actx)A.actx=new(window.AudioContext||window.webkitAudioContext)({sampleRate:44100});if(A.actx.state==='suspended')await A.actx.resume();A.cs=new MediaStream(at);A.cx=A.actx.createMediaStreamSource(A.cs);A.gain=A.actx.createGain();A.gain.gain.value=(A.hv/100)*(A.gv/100);A.cx.connect(A.gain);A.gain.connect(A.actx.destination);at[0].addEventListener('ended',stopYtCap);const st=document.getElementById('ytCapSt');st.textContent='‚úì Capturing ‚Äî all speakers in sync';st.classList.add('on');document.getElementById('ytCapBtn').style.display='none';document.getElementById('ytStopBtn').style.display='';if(A.eng)A.eng.send({type:'captureStart',name:document.getElementById('npTitle').textContent,src:'yt'});toast('üéôÔ∏è All speakers synced!');}catch(e){if(e.name==='NotAllowedError')toast('Permission denied');else toast('Error: '+e.message);}}
function stopYtCap(){if(A.cs){A.cs.getTracks().forEach(t=>t.stop());A.cs=null;}if(A.cx){try{A.cx.disconnect();}catch(e){}A.cx=null;}A.gain=null;const st=document.getElementById('ytCapSt');st.textContent='Tap Capture to sync speakers';st.classList.remove('on');document.getElementById('ytCapBtn').style.display='';document.getElementById('ytStopBtn').style.display='none';}

/* CAPTURE */
async function startCap(){try{const s=await navigator.mediaDevices.getDisplayMedia({video:true,audio:{echoCancellation:false,noiseSuppression:false,sampleRate:44100}});const at=s.getAudioTracks();if(!at.length){s.getTracks().forEach(t=>t.stop());toast('No audio ‚Äî enable "Share system audio"');return;}s.getVideoTracks().forEach(t=>t.stop());if(!A.actx)A.actx=new(window.AudioContext||window.webkitAudioContext)({sampleRate:44100});if(A.actx.state==='suspended')await A.actx.resume();A.cs=new MediaStream(at);A.cx=A.actx.createMediaStreamSource(A.cs);A.gain=A.actx.createGain();A.gain.gain.value=(A.hv/100)*(A.gv/100);A.cx.connect(A.gain);A.gain.connect(A.actx.destination);at[0].addEventListener('ended',stopCap);const st=document.getElementById('capSt');st.querySelector('span').textContent='Capturing ‚úì';st.classList.add('on');st.querySelector('.dot').classList.add('on');document.getElementById('capBtn').style.display='none';document.getElementById('capStop').style.display='';setNP('System Audio','Live Capture','var(--yw)','üéôÔ∏è');A.playing=true;setPPIco(true);document.getElementById('waves').classList.remove('off');if(A.eng)A.eng.send({type:'captureStart',name:'System Audio',src:'sys'});toast('üéôÔ∏è Capturing ‚Äî speakers in sync');}catch(e){if(e.name==='NotAllowedError')toast('Permission denied');else toast('Error: '+e.message);}}
function stopCap(){if(A.cs){A.cs.getTracks().forEach(t=>t.stop());A.cs=null;}if(A.cx){try{A.cx.disconnect();}catch(e){}A.cx=null;}A.gain=null;const st=document.getElementById('capSt');st.querySelector('span').textContent='Not capturing';st.classList.remove('on');document.getElementById('capBtn').style.display='';document.getElementById('capStop').style.display='none';A.playing=false;setPPIco(false);document.getElementById('waves').classList.add('off');if(A.eng)A.eng.send({type:'pause'});toast('Capture stopped');}

/* UTILS */
function setNP(t,s,c,i){document.getElementById('npTitle').textContent=t;document.getElementById('srcLbl').textContent=s;document.getElementById('srcDot').style.background=c;const a=document.getElementById('artEl');a.innerHTML='';a.textContent=i;}
function setStatus(dc,lb){document.getElementById('sd').className='dot '+dc;document.getElementById('sl').textContent=lb;}
function setJMsg(m){const e=document.getElementById('joinMsg');if(e)e.textContent=m;}
let _tt;function toast(m){const t=document.getElementById('toast');t.textContent=m;t.classList.add('on');clearTimeout(_tt);_tt=setTimeout(()=>t.classList.remove('on'),2800);}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}

/* DRAG DROP */
const db=document.getElementById('dropBox');
db.addEventListener('dragover',e=>{e.preventDefault();db.classList.add('drag');});
db.addEventListener('dragleave',()=>db.classList.remove('drag'));
db.addEventListener('drop',e=>{e.preventDefault();db.classList.remove('drag');const f=Array.from(e.dataTransfer.files).filter(f=>f.type.startsWith('audio/'));if(f.length){const dt=new DataTransfer();f.forEach(x=>dt.items.add(x));addFiles({target:{files:dt.files}});}});
document.addEventListener('touchstart',()=>{if(A.actx&&A.actx.state==='suspended')A.actx.resume();},{passive:true});
</script>
</body>
</html>
