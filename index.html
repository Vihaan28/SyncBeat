<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>SyncBeat</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Syne:wght@400;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #080c10;
    --surface: #0f1419;
    --surface2: #161d26;
    --border: #1e2a38;
    --accent: #00e5ff;
    --accent2: #7c3aed;
    --accent3: #10b981;
    --warn: #f59e0b;
    --danger: #ef4444;
    --spotify: #1db954;
    --apple: #fc3c44;
    --amazon: #ff9900;
    --text: #e8f0fe;
    --text2: #8899aa;
    --text3: #3d5166;
    --radius: 16px;
    --radius-sm: 8px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  html, body {
    height: 100%;
    background: var(--bg);
    color: var(--text);
    font-family: 'Syne', sans-serif;
    overflow: hidden;
    user-select: none;
  }

  body {
    display: flex;
    flex-direction: column;
    max-width: 430px;
    margin: 0 auto;
    height: 100dvh;
    position: relative;
  }

  .bg-pulse {
    position: fixed; top: -200px; left: 50%;
    transform: translateX(-50%);
    width: 600px; height: 600px;
    background: radial-gradient(circle, rgba(0,229,255,0.06) 0%, transparent 70%);
    border-radius: 50%; pointer-events: none !important; z-index: 0;
    animation: bgpulse 4s ease-in-out infinite;
  }
  .bg-pulse2 {
    position: fixed; bottom: -200px; left: 30%;
    width: 400px; height: 400px;
    background: radial-gradient(circle, rgba(124,58,237,0.05) 0%, transparent 70%);
    border-radius: 50%; pointer-events: none !important; z-index: 0;
  }
  @keyframes bgpulse {
    0%,100%{opacity:.5;transform:translateX(-50%) scale(1)}
    50%{opacity:1;transform:translateX(-50%) scale(1.1)}
  }

  /* HEADER */
  .header {
    flex-shrink: 0; padding: 16px 20px 12px;
    display: flex; align-items: center; justify-content: space-between;
    position: relative; z-index: 10; pointer-events: auto;
  }
  .logo { display: flex; align-items: center; gap: 8px; }
  .logo-icon {
    width: 32px; height: 32px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border-radius: 8px; display: flex; align-items: center; justify-content: center;
  }
  .logo-text {
    font-size: 20px; font-weight: 800; letter-spacing: -0.5px;
    background: linear-gradient(90deg, var(--text) 0%, var(--accent) 100%);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }
  .status-pill {
    display: flex; align-items: center; gap: 6px;
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 20px; padding: 5px 10px;
  }
  .status-dot {
    width: 7px; height: 7px; border-radius: 50%;
    background: var(--text3); transition: all 0.3s;
  }
  .status-dot.online { background: var(--accent3); box-shadow: 0 0 8px var(--accent3); animation: dotpulse 2s infinite; }
  .status-dot.hosting { background: var(--accent); box-shadow: 0 0 8px var(--accent); animation: dotpulse 2s infinite; }
  @keyframes dotpulse{0%,100%{opacity:1}50%{opacity:.4}}
  .status-label { font-family:'DM Mono',monospace; font-size:10px; color:var(--text2); }

  /* SCREENS */
  .screen { display: none; flex-direction: column; flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; position: relative; z-index: 2; }
  #joinScreen { overflow-y: auto; }
  #joinScreen { overflow-y: auto; -webkit-overflow-scrolling: touch; }
  .screen.active { display: flex; }

  /* SCROLL AREA */
  .scroll-area { flex:1; overflow-y:auto; overflow-x:hidden; display:block; position:relative; z-index:2; }
  .scroll-area::-webkit-scrollbar{width:2px}
  .scroll-area::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}

  /* HOME */
  .hero {
    flex: 1; display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    padding: 24px 20px; gap: 28px;
    overflow-y: auto; -webkit-overflow-scrolling: touch;
    position: relative; z-index: 2;
  }
  .hero-visual { position: relative; width: 160px; height: 160px; }
  .rings { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; }
  .ring {
    position: absolute; border: 1px solid rgba(0,229,255,0.15);
    border-radius: 50%; animation: ringexpand 3s ease-out infinite;
  }
  .ring:nth-child(1){width:80px;height:80px;animation-delay:0s}
  .ring:nth-child(2){width:120px;height:120px;animation-delay:.8s}
  .ring:nth-child(3){width:160px;height:160px;animation-delay:1.6s}
  @keyframes ringexpand{0%{opacity:.8}100%{opacity:0;transform:scale(1.2)}}
  .hero-btn {
    width: 72px; height: 72px; border-radius: 50%;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    display: flex; align-items: center; justify-content: center;
    position: relative; z-index: 2; box-shadow: 0 0 40px rgba(0,229,255,0.3);
  }
  .hero-label { text-align: center; }
  .hero-label h2 { font-size: 22px; font-weight: 800; margin-bottom: 6px; }
  .hero-label p { font-size: 13px; color: var(--text2); line-height: 1.5; max-width: 280px; }

  /* BUTTONS */
  .btn-row { display: flex; gap: 10px; width: 100%; position: relative; z-index: 5; }
  .btn {
    flex: 1; padding: 15px 12px; border-radius: var(--radius);
    border: none; cursor: pointer; font-family: 'Syne', sans-serif;
    font-size: 14px; font-weight: 700; letter-spacing: 0.3px;
    transition: all 0.2s; position: relative; overflow: hidden;
    touch-action: manipulation; -webkit-tap-highlight-color: transparent;
  }
  .btn:active{transform:scale(0.97)}
  .btn-primary{background:var(--accent);color:#000}
  .btn-primary:hover{background:#33eaff}
  .btn-secondary{background:var(--surface2);color:var(--text);border:1px solid var(--border)}
  .btn-secondary:hover{border-color:var(--accent);color:var(--accent)}
  .btn-ghost{background:transparent;color:var(--text2);border:1px solid var(--border)}
  .btn-ghost:hover{border-color:var(--text2)}
  .btn-danger{background:var(--danger);color:#fff}
  .btn-full{width:100%;flex:none}

  /* SECTION */
  .section { padding: 0 20px; margin-bottom: 14px; }
  .section-header { display:flex;align-items:center;justify-content:space-between;margin-bottom:10px; }
  .section-title { font-size:11px;text-transform:uppercase;letter-spacing:2px;color:var(--text3);font-family:'DM Mono',monospace; }
  .badge {
    font-family:'DM Mono',monospace; font-size:10px; padding:3px 8px;
    border-radius:20px; background:var(--surface2); color:var(--text2); border:1px solid var(--border);
  }
  .badge.live{background:rgba(0,229,255,0.1);color:var(--accent);border-color:rgba(0,229,255,0.3)}
  .badge.green{background:rgba(16,185,129,0.1);color:var(--accent3);border-color:rgba(16,185,129,0.3)}

  /* CARDS */
  .card {
    background:var(--surface); border:1px solid var(--border);
    border-radius:var(--radius); padding:16px; transition:all 0.2s;
  }
  .card.accent-border{border-color:rgba(0,229,255,0.25);background:rgba(0,229,255,0.03)}
  .card.green-border{border-color:rgba(16,185,129,0.25);background:rgba(16,185,129,0.03)}
  .card.warn-border{border-color:rgba(245,158,11,0.25);background:rgba(245,158,11,0.03)}

  /* ROOM CODE */
  .room-code-display {
    background:var(--surface); border:1px solid var(--border);
    border-radius:var(--radius); padding:18px 20px; text-align:center;
  }
  .room-code {
    font-family:'DM Mono',monospace; font-size:34px; font-weight:500;
    letter-spacing:8px; color:var(--accent); display:block; margin:6px 0;
  }
  .room-code-label{font-size:11px;text-transform:uppercase;letter-spacing:2px;color:var(--text3)}

  /* SOURCE SELECTOR */
  .source-tabs {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 8px;
    padding: 0 20px;
    margin-bottom: 14px;
  }
  .source-tab {
    padding: 11px 6px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--text2);
    font-family: 'Syne', sans-serif;
    font-size: 11px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    text-align: center;
    line-height: 1.2;
  }
  .source-tab .tab-icon { font-size: 20px; }
  .source-tab.active {
    border-color: var(--accent);
    color: var(--accent);
    background: rgba(0,229,255,0.08);
  }
  .source-tab .dot { display: none; }
  .source-tab .dot { width: 8px; height: 8px; border-radius: 50%; }

  /* SOURCE PANELS */
  .source-panel { display: none; }
  .source-panel.active { display: block; }

  /* STREAMING CARDS */
  .streaming-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 0 20px; margin-bottom: 14px; }
  .streaming-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 16px 12px; text-align: center;
    cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden;
  }
  .streaming-card:active{transform:scale(0.97)}
  .streaming-card .svc-icon { font-size: 28px; margin-bottom: 8px; display: block; }
  .streaming-card .svc-name { font-size: 13px; font-weight: 700; }
  .streaming-card .svc-sub { font-size: 10px; color: var(--text2); margin-top: 3px; font-family:'DM Mono',monospace; }
  .streaming-card.spotify { border-color: rgba(29,185,84,0.3); }
  .streaming-card.spotify:hover { background: rgba(29,185,84,0.08); }
  .streaming-card.apple { border-color: rgba(252,60,68,0.3); }
  .streaming-card.apple:hover { background: rgba(252,60,68,0.08); }
  .streaming-card.amazon { border-color: rgba(255,153,0,0.3); }
  .streaming-card.amazon:hover { background: rgba(255,153,0,0.08); }
  .streaming-card.youtube { border-color: rgba(255,0,0,0.3); }
  .streaming-card.youtube:hover { background: rgba(255,0,0,0.08); }
  .streaming-card .active-badge {
    position: absolute; top: 8px; right: 8px;
    width: 8px; height: 8px; border-radius: 50%;
    background: var(--accent3); box-shadow: 0 0 6px var(--accent3);
    display: none;
  }
  .streaming-card.capturing .active-badge { display: block; }

  /* CAPTURE PANEL */
  .capture-panel {
    margin: 0 20px 14px; padding: 18px;
    background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius);
  }
  .capture-icon-wrap {
    width: 56px; height: 56px; border-radius: 14px;
    background: linear-gradient(135deg, rgba(0,229,255,0.15), rgba(124,58,237,0.15));
    display: flex; align-items: center; justify-content: center;
    margin-bottom: 14px; font-size: 26px;
  }
  .capture-title { font-size: 16px; font-weight: 800; margin-bottom: 6px; }
  .capture-desc { font-size: 12px; color: var(--text2); line-height: 1.6; margin-bottom: 16px; }
  .capture-steps { display: flex; flex-direction: column; gap: 10px; margin-bottom: 16px; }
  .capture-step { display: flex; gap: 12px; align-items: flex-start; }
  .step-num {
    width: 22px; height: 22px; border-radius: 50%; flex-shrink: 0;
    background: rgba(0,229,255,0.15); border: 1px solid rgba(0,229,255,0.3);
    display: flex; align-items: center; justify-content: center;
    font-size: 10px; font-weight: 800; color: var(--accent); margin-top: 1px;
  }
  .step-text { font-size: 12px; color: var(--text2); line-height: 1.5; }
  .step-text strong { color: var(--text); }

  /* CAPTURE STATUS */
  .capture-status {
    display: flex; align-items: center; gap: 10px;
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: var(--radius-sm); padding: 12px 14px; margin-bottom: 12px;
  }
  .capture-status.active { border-color: rgba(16,185,129,0.3); background: rgba(16,185,129,0.05); }
  .capture-status.active .cs-dot { background: var(--accent3); box-shadow: 0 0 6px var(--accent3); animation: dotpulse 2s infinite; }
  .cs-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--text3); flex-shrink: 0; }
  .cs-text { font-size: 12px; color: var(--text2); font-family:'DM Mono',monospace; }
  .cs-text span { color: var(--text); }

  /* VOLUME CONTROLS */
  .speaker-card {
    background:var(--surface); border:1px solid var(--border);
    border-radius:var(--radius); padding:14px; transition:all 0.2s;
    position:relative; overflow:hidden;
  }
  .speaker-card.active-spk{border-color:rgba(0,229,255,0.25);background:rgba(0,229,255,0.03)}
  .speaker-card.me-spk{border-color:rgba(16,185,129,0.3);background:rgba(16,185,129,0.03)}
  .speaker-card::before{
    content:'';position:absolute;top:0;left:0;right:0;height:1px;
    background:linear-gradient(90deg,transparent,rgba(0,229,255,0.3),transparent);
    opacity:0;transition:opacity 0.3s;
  }
  .speaker-card.active-spk::before{opacity:1}
  .speaker-top{display:flex;align-items:center;gap:10px;margin-bottom:12px}
  .speaker-icon{
    width:38px;height:38px;border-radius:9px;
    display:flex;align-items:center;justify-content:center;flex-shrink:0;
  }
  .speaker-icon.host{background:rgba(0,229,255,0.12)}
  .speaker-icon.client{background:rgba(124,58,237,0.12)}
  .speaker-icon.me-icon{background:rgba(16,185,129,0.12)}
  .speaker-info{flex:1;min-width:0}
  .speaker-name{font-size:14px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .speaker-sub{font-size:10px;color:var(--text2);margin-top:2px;font-family:'DM Mono',monospace}
  .speaker-status{width:8px;height:8px;border-radius:50%;flex-shrink:0}
  .speaker-status.synced{background:var(--accent3);box-shadow:0 0 6px var(--accent3)}
  .speaker-status.syncing{background:var(--warn);animation:dotpulse 1s infinite}
  .speaker-status.offline{background:var(--text3)}

  .volume-row{display:flex;align-items:center;gap:8px}
  .vol-icon{color:var(--text3);flex-shrink:0}
  .slider-wrap{flex:1;position:relative;height:36px;display:flex;align-items:center}
  input[type=range]{
    -webkit-appearance:none;appearance:none;width:100%;height:4px;
    border-radius:2px;background:var(--border);outline:none;cursor:pointer;
  }
  input[type=range]::-webkit-slider-thumb{
    -webkit-appearance:none;width:18px;height:18px;border-radius:50%;
    background:var(--accent);box-shadow:0 0 10px rgba(0,229,255,0.5);cursor:pointer;
  }
  input[type=range]::-moz-range-thumb{
    width:18px;height:18px;border-radius:50%;background:var(--accent);
    border:none;box-shadow:0 0 10px rgba(0,229,255,0.5);cursor:pointer;
  }
  .vol-value{font-family:'DM Mono',monospace;font-size:11px;color:var(--text2);width:26px;text-align:right;flex-shrink:0}
  .mute-btn{
    width:28px;height:28px;border-radius:6px;background:var(--surface2);
    border:1px solid var(--border);display:flex;align-items:center;justify-content:center;
    cursor:pointer;flex-shrink:0;transition:all 0.2s;
  }
  .mute-btn:active{transform:scale(0.9)}
  .mute-btn.muted{background:rgba(239,68,68,0.15);border-color:rgba(239,68,68,0.3)}

  /* GLOBAL VOL */
  .global-vol-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px}
  .global-vol-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
  .global-vol-title{font-size:12px;font-weight:700;color:var(--text2);letter-spacing:1px}

  /* WAVEFORM */
  .waveform{display:flex;align-items:center;gap:3px;height:20px}
  .wave-bar{width:3px;background:var(--accent);border-radius:2px;animation:wave 1.2s ease-in-out infinite}
  .wave-bar:nth-child(1){animation-delay:0s;height:8px}
  .wave-bar:nth-child(2){animation-delay:.2s;height:16px}
  .wave-bar:nth-child(3){animation-delay:.4s;height:12px}
  .wave-bar:nth-child(4){animation-delay:.1s;height:20px}
  .wave-bar:nth-child(5){animation-delay:.3s;height:10px}
  @keyframes wave{0%,100%{transform:scaleY(.4);opacity:.6}50%{transform:scaleY(1);opacity:1}}
  .waveform.paused .wave-bar{animation:none;transform:scaleY(0.3);opacity:.4}

  /* PLAYER BAR */
  .player-bar{
    flex-shrink:0;padding:12px 20px;
    padding-bottom:calc(12px + env(safe-area-inset-bottom));
    background:var(--surface);border-top:1px solid var(--border);
    position:relative;z-index:10;
  }
  .now-playing{display:flex;align-items:center;gap:12px;margin-bottom:12px}
  .track-art{
    width:44px;height:44px;border-radius:8px;
    background:linear-gradient(135deg,var(--surface2),var(--border));
    flex-shrink:0;display:flex;align-items:center;justify-content:center;
    position:relative;overflow:hidden;font-size:22px;
  }
  .track-art.playing::after{
    content:'';position:absolute;inset:0;
    background:linear-gradient(135deg,rgba(0,229,255,0.15),rgba(124,58,237,0.15));
    animation:artpulse 2s ease-in-out infinite;
  }
  @keyframes artpulse{0%,100%{opacity:.5}50%{opacity:1}}
  .track-info{flex:1;min-width:0}
  .track-title{font-size:14px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .track-source{font-size:11px;color:var(--text2);margin-top:2px;display:flex;align-items:center;gap:4px}
  .source-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
  .transport{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .transport-btn{
    width:40px;height:40px;border-radius:50%;background:transparent;border:none;
    color:var(--text2);display:flex;align-items:center;justify-content:center;
    cursor:pointer;transition:all .15s;
  }
  .transport-btn:active{transform:scale(.9);color:var(--text)}
  .play-pause-btn{
    width:50px;height:50px;border-radius:50%;background:var(--accent);border:none;
    color:#000;display:flex;align-items:center;justify-content:center;cursor:pointer;
    box-shadow:0 0 20px rgba(0,229,255,0.4);transition:all .15s;flex-shrink:0;
  }
  .play-pause-btn:active{transform:scale(.93)}
  .progress-wrap{
    position:relative;height:3px;background:var(--border);
    border-radius:2px;margin-bottom:10px;cursor:pointer;
  }
  .progress-fill{position:absolute;left:0;top:0;bottom:0;background:var(--accent);border-radius:2px;transition:width .3s linear}
  .progress-thumb{
    position:absolute;top:50%;transform:translateY(-50%);
    width:12px;height:12px;border-radius:50%;background:var(--accent);
    box-shadow:0 0 8px rgba(0,229,255,.6);margin-left:-6px;transition:left .3s linear;
  }

  /* JOIN / INPUT */
  .join-form{padding:20px;display:flex;flex-direction:column;gap:14px;flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;}
  .input-label{font-size:11px;text-transform:uppercase;letter-spacing:2px;color:var(--text3);font-family:'DM Mono',monospace;margin-bottom:6px;display:block}
  input[type=text]{
    width:100%;background:var(--surface);border:1px solid var(--border);
    border-radius:var(--radius-sm);padding:14px 16px;color:var(--text);
    font-family:'DM Mono',monospace;font-size:16px;letter-spacing:4px;
    text-transform:uppercase;outline:none;transition:border-color .2s;
  }
  input[type=text]:focus{border-color:var(--accent)}
  input[type=text].normal{letter-spacing:0;text-transform:none;font-size:15px}

  /* UPLOAD */
  .upload-area{
    border:2px dashed var(--border);border-radius:var(--radius);
    padding:28px 20px;text-align:center;cursor:pointer;transition:all .2s;
    margin:0 20px 14px;position:relative;
  }
  .upload-area:hover,.upload-area.drag{border-color:var(--accent);background:rgba(0,229,255,.04)}
  .upload-area input{position:absolute;inset:0;opacity:0;cursor:pointer}
  .upload-area p{font-size:12px;color:var(--text2);margin-top:6px}

  /* FILE LIST */
  .file-list{padding:0 20px;display:flex;flex-direction:column;gap:8px;margin-bottom:14px}
  .file-item{
    background:var(--surface);border:1px solid var(--border);
    border-radius:var(--radius-sm);padding:11px 14px;
    display:flex;align-items:center;gap:10px;cursor:pointer;transition:all .2s;
  }
  .file-item:hover,.file-item.playing{border-color:rgba(0,229,255,.3);background:rgba(0,229,255,.04)}
  .file-item .file-name{flex:1;font-size:13px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  /* SPEAKERS LIST */
  .speakers-list{display:flex;flex-direction:column;gap:10px;padding:0 20px;margin-bottom:14px}

  /* TOAST */
  .toast{
    position:fixed;bottom:100px;left:50%;
    transform:translateX(-50%) translateY(20px);
    background:var(--surface2);border:1px solid var(--border);
    color:var(--text);padding:10px 20px;border-radius:40px;
    font-size:12px;font-family:'DM Mono',monospace;white-space:nowrap;
    opacity:0;transition:all .3s;z-index:100;pointer-events:none;
  }
  .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

  /* MODAL OVERLAY */
  .modal-overlay{
    position:fixed;inset:0;background:rgba(8,12,16,.9);
    display:none;align-items:flex-end;justify-content:center;
    z-index:200;opacity:0;pointer-events:none;transition:opacity .3s;
  }
  .modal-overlay.show{display:flex;opacity:1;pointer-events:all}
  .modal-sheet{
    background:var(--surface);border:1px solid var(--border);
    border-radius:20px 20px 0 0;padding:20px;width:100%;
    max-width:430px;transform:translateY(100%);transition:transform .35s cubic-bezier(.32,.72,0,1);
  }
  .modal-overlay.show .modal-sheet{transform:translateY(0)}
  .modal-handle{width:36px;height:4px;border-radius:2px;background:var(--border);margin:0 auto 20px}

  /* LATENCY */
  .latency{
    font-family:'DM Mono',monospace;font-size:10px;color:var(--accent3);
    background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.2);
    padding:2px 6px;border-radius:4px;
  }

  @media(min-width:430px){body{border-left:1px solid var(--border);border-right:1px solid var(--border)}}

  /* YOUTUBE PLAYER */
  .yt-player-wrap {
    margin: 0 20px 14px;
    border-radius: var(--radius);
    overflow: visible;
    border: 1px solid var(--border);
    background: var(--surface);
    position: relative;
    min-height: 60px;
  }
  .yt-search-bar {
    display: flex; gap: 8px; padding: 12px;
    border-bottom: 1px solid var(--border);
  }
  .yt-search-input {
    flex: 1; background: var(--surface2); border: 1px solid var(--border);
    border-radius: var(--radius-sm); padding: 10px 12px; color: var(--text);
    font-family: 'DM Mono', monospace; font-size: 13px; outline: none;
    letter-spacing: 0; text-transform: none;
  }
  .yt-search-input:focus { border-color: var(--accent); }
  .yt-search-btn {
    padding: 10px 14px; border-radius: var(--radius-sm);
    background: #ff0000; border: none; color: #fff;
    font-family: 'Syne', sans-serif; font-weight: 700; font-size: 13px;
    cursor: pointer; flex-shrink: 0; transition: all 0.2s;
  }
  .yt-search-btn:active { transform: scale(0.95); }
  .yt-iframe-wrap {
    position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;
    display: none;
  }
  .yt-iframe-wrap.visible { display: block; }
  .yt-iframe-wrap iframe {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none;
  }
  .yt-capture-bar {
    padding: 12px; display: flex; align-items: center; gap: 10px;
    border-top: 1px solid var(--border);
  }
  .yt-capture-status {
    flex: 1; font-size: 11px; color: var(--text2); font-family: 'DM Mono', monospace;
  }
  .yt-capture-status.active { color: var(--accent3); }
  .yt-results {
    max-height: 260px; overflow-y: auto; padding: 8px;
    display: none; gap: 6px;
    border-top: 1px solid var(--border);
    flex-direction: column;
  }
  .yt-results.visible { display: flex; }
  .yt-result-item {
    display: flex; gap: 10px; align-items: center;
    padding: 8px; border-radius: var(--radius-sm);
    cursor: pointer; transition: background 0.15s;
    border: 1px solid transparent;
  }
  .yt-result-item:hover { background: var(--surface2); border-color: var(--border); }
  .yt-result-thumb {
    width: 60px; height: 45px; border-radius: 6px; object-fit: cover;
    flex-shrink: 0; background: var(--surface2);
  }
  .yt-result-info { flex: 1; min-width: 0; }
  .yt-result-title {
    font-size: 12px; font-weight: 700; white-space: nowrap;
    overflow: hidden; text-overflow: ellipsis; margin-bottom: 2px;
  }
  .yt-result-ch { font-size: 10px; color: var(--text2); font-family: 'DM Mono', monospace; }
  .yt-loading {
    padding: 20px; text-align: center; font-size: 12px;
    color: var(--text2); font-family: 'DM Mono', monospace; display: none;
  }
  .yt-loading.visible { display: block; }
  .yt-quick-btns {
    padding: 8px 12px 12px; display: flex; gap: 8px; flex-wrap: wrap;
  }
  .yt-quick-btn {
    padding: 6px 12px; border-radius: 20px;
    background: var(--surface2); border: 1px solid var(--border);
    color: var(--text2); font-size: 11px; font-family: 'Syne', sans-serif;
    font-weight: 700; cursor: pointer; transition: all 0.2s;
  }
  .yt-quick-btn:hover { border-color: #ff0000; color: #ff0000; }
  .no-share-badge {
    display: inline-flex; align-items: center; gap: 4px;
    background: rgba(16,185,129,0.12); border: 1px solid rgba(16,185,129,0.3);
    color: var(--accent3); font-size: 10px; font-family: 'DM Mono', monospace;
    padding: 3px 8px; border-radius: 20px; margin-bottom: 10px;
  }

</style>
</head>
<body>

<div class="bg-pulse"></div>
<div class="bg-pulse2"></div>
<div class="toast" id="toast"></div>

<!-- CAPTURE INSTRUCTIONS MODAL -->
<div class="modal-overlay" id="captureModal">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div id="captureModalContent"></div>
  </div>
</div>

<!-- HEADER -->
<div class="header">
  <div class="logo">
    <div class="logo-icon">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M9 18V5l12-2v13"/>
        <circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/>
      </svg>
    </div>
    <span class="logo-text">SyncBeat</span>
  </div>
  <div class="status-pill">
    <div class="status-dot" id="statusDot"></div>
    <span class="status-label" id="statusLabel">offline</span>
  </div>
</div>

<!-- =================== HOME SCREEN =================== -->
<div class="screen active" id="homeScreen">
  <div class="hero">
    <div class="hero-visual">
      <div class="rings"><div class="ring"></div><div class="ring"></div><div class="ring"></div></div>
      <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;">
        <div class="hero-btn">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="black"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
        </div>
      </div>
    </div>

    <div class="hero-label">
      <h2>Multi-Speaker Sync</h2>
      <p>Play Spotify, Apple Music, any app ‚Äî perfectly in sync across every room.</p>
    </div>

    <div style="width:100%;padding:0 4px">
      <div class="card accent-border" style="margin-bottom:14px">
        <p style="font-size:12px;color:var(--text2);line-height:1.6">
          <span style="color:var(--accent);font-weight:700">How it works:</span> The <strong style="color:var(--text)">Host</strong> plays music from any app and captures the audio. Other devices join and each play through their own Bluetooth speaker ‚Äî all in sync over Wi-Fi.
        </p>
      </div>
    </div>

    <div class="btn-row" style="padding:0 4px;position:relative;z-index:10;">
      <button class="btn btn-primary" onclick="showHostSetup()"
        style="touch-action:manipulation;-webkit-tap-highlight-color:transparent;cursor:pointer;position:relative;z-index:10;">
        üéµ Host Session
      </button>
      <button class="btn btn-secondary" onclick="showJoin()"
        style="touch-action:manipulation;-webkit-tap-highlight-color:transparent;cursor:pointer;position:relative;z-index:10;">
        üì° Join Session
      </button>
    </div>
  </div>
</div>

<!-- =================== JOIN SCREEN =================== -->
<div class="screen" id="joinScreen">
  <div style="padding:20px;display:flex;flex-direction:column;gap:16px;overflow-y:auto;-webkit-overflow-scrolling:touch;flex:1;">

    <div>
      <h2 style="font-size:20px;font-weight:800;margin-bottom:6px">Join a Session</h2>
      <p style="font-size:12px;color:var(--text2);line-height:1.5">Enter the room code shown on the host device.</p>
    </div>

    <div>
      <label class="input-label">Room Code</label>
      <input type="text" id="roomCodeInput" maxlength="6" placeholder="XXXXXX"
        oninput="this.value=this.value.toUpperCase().replace(/[^A-Z0-9]/g,'')"
        style="width:100%;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:16px;color:var(--text);font-family:'DM Mono',monospace;font-size:22px;letter-spacing:8px;text-transform:uppercase;outline:none;text-align:center;box-sizing:border-box;">
    </div>

    <div>
      <label class="input-label">Your Speaker Name</label>
      <input type="text" id="clientNameInput" placeholder="e.g. Kitchen Speaker" maxlength="24"
        style="width:100%;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:16px;color:var(--text);font-family:'DM Mono',monospace;font-size:15px;outline:none;box-sizing:border-box;">
    </div>

    <div id="joinStatusMsg" style="font-family:'DM Mono',monospace;font-size:11px;color:var(--accent3);text-align:center;min-height:18px;padding:2px 0;"></div>

    <!-- Big easy-to-tap connect button -->
    <button onclick="joinSession()" id="joinConnectBtn"
      style="width:100%;padding:18px;border-radius:14px;border:none;background:var(--accent);color:#000;font-family:'Syne',sans-serif;font-size:16px;font-weight:800;cursor:pointer;letter-spacing:0.3px;-webkit-tap-highlight-color:transparent;touch-action:manipulation;">
      Connect ‚Üí
    </button>

    <button onclick="goHome()"
      style="width:100%;padding:14px;border-radius:14px;border:1px solid var(--border);background:transparent;color:var(--text2);font-family:'Syne',sans-serif;font-size:14px;font-weight:700;cursor:pointer;-webkit-tap-highlight-color:transparent;touch-action:manipulation;">
      ‚Üê Back
    </button>

  </div>
</div>

<!-- =================== HOST SCREEN =================== -->
<div class="screen" id="hostScreen">
  <div class="scroll-area">

    <!-- Room Code -->
    <div class="section">
      <div class="room-code-display">
        <span class="room-code-label">Room Code ‚Äî share with others</span>
        <span class="room-code" id="displayRoomCode">------</span>
        <div style="display:flex;align-items:center;justify-content:center;gap:8px;margin-top:8px;margin-bottom:10px">
          <span id="p2pBadge" style="font-family:'DM Mono',monospace;font-size:10px;padding:3px 8px;border-radius:20px;border:1px solid var(--border);color:var(--text3);background:var(--surface2)">‚è≥ Connecting...</span>
        </div>
        <div style="display:flex;gap:8px;justify-content:center">
          <button class="btn btn-secondary" style="flex:none;padding:8px 18px;font-size:12px" onclick="copyRoomCode()">üìã Copy Code</button>
          <button class="btn btn-ghost" style="flex:none;padding:8px 18px;font-size:12px" onclick="goHome()">End Session</button>
        </div>
      </div>
    </div>

    <!-- Source Selector -->
    <div style="padding:0 20px;margin-bottom:10px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
        <div class="section-title">AUDIO SOURCE</div>
        <span style="font-size:10px;color:var(--text3);font-family:'DM Mono',monospace">tap a tab below</span>
      </div>
    </div>

    <div class="source-tabs">
      <button class="source-tab active" onclick="setSourceTab('files', this)">
        <span class="tab-icon">üìÅ</span>
        My Files
      </button>
      <button class="source-tab" onclick="setSourceTab('streaming', this)">
        <span class="tab-icon">üéµ</span>
        Streaming
      </button>
      <button class="source-tab" onclick="setSourceTab('capture', this)">
        <span class="tab-icon">üéôÔ∏è</span>
        System Audio
      </button>
    </div>

    <!-- MY FILES PANEL -->
    <div class="source-panel active" id="panel-files">
      <div class="upload-area" id="uploadArea">
        <input type="file" accept="audio/*" multiple onchange="handleFiles(event)" id="fileInput">
        <svg width="26" height="26" viewBox="0 0 24 24" fill="var(--text3)"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/></svg>
        <p>Tap to upload audio files<br><span style="font-size:11px;color:var(--text3)">MP3, WAV, AAC, FLAC, OGG</span></p>
      </div>
      <div class="file-list" id="fileList"></div>
    </div>

    <!-- STREAMING APPS PANEL -->
    <div class="source-panel" id="panel-streaming">

      <!-- Header -->
      <div style="padding:0 20px;margin-bottom:12px">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
          <span style="font-size:20px">‚ñ∂Ô∏è</span>
          <div>
            <div style="font-size:15px;font-weight:800">YouTube Music</div>
            <div style="font-size:11px;color:var(--text2)">Built-in ‚Äî no screen share needed</div>
          </div>
          <span class="no-share-badge" style="margin-left:auto;margin-bottom:0">‚úì No screen share</span>
        </div>
        <div class="card green-border" style="font-size:12px;color:var(--text2);line-height:1.6">
          Search and play YouTube Music directly inside SyncBeat. Tap <strong style="color:var(--accent3)">Capture Audio</strong> once and all connected speakers play in sync ‚Äî no screen share dialog.
        </div>
      </div>

      <!-- Built-in YouTube Player -->
      <div class="yt-player-wrap">

        <!-- Search bar -->
        <div class="yt-search-bar">
          <input class="yt-search-input" id="ytSearchInput" type="text"
            placeholder="Search YouTube Music..."
            onkeydown="if(event.key==='Enter')ytSearch()"
            style="letter-spacing:0;text-transform:none">
          <button class="yt-search-btn" onclick="ytSearch()">‚ñ∂ Search</button>
        </div>

        <!-- Quick genre buttons -->
        <div class="yt-quick-btns">
          <button class="yt-quick-btn" onclick="ytQuick('top hits 2024')">üî• Top Hits</button>
          <button class="yt-quick-btn" onclick="ytQuick('chill lo-fi music')">üòå Lo-Fi</button>
          <button class="yt-quick-btn" onclick="ytQuick('hip hop playlist')">üé§ Hip Hop</button>
          <button class="yt-quick-btn" onclick="ytQuick('pop music playlist')">üéµ Pop</button>
          <button class="yt-quick-btn" onclick="ytQuick('workout music')">üí™ Workout</button>
          <button class="yt-quick-btn" onclick="ytQuick('jazz music')">üé∑ Jazz</button>
        </div>

        <!-- Loading -->
        <div class="yt-loading" id="ytLoading">Searching...</div>

        <!-- Results list -->
        <div class="yt-results" id="ytResults"></div>

        <!-- Video iframe -->
        <div class="yt-iframe-wrap" id="ytIframeWrap">
          <iframe id="ytIframe" allow="autoplay; encrypted-media" allowfullscreen></iframe>
        </div>

        <!-- Capture bar -->
        <div class="yt-capture-bar">
          <div class="yt-capture-status" id="ytCaptureStatus">Audio not captured yet</div>
          <button class="btn btn-success" style="flex:none;padding:8px 14px;font-size:12px" id="ytCaptureBtn" onclick="startYTCapture()">
            üéôÔ∏è Capture Audio
          </button>
          <button class="btn btn-ghost" style="flex:none;padding:8px 10px;font-size:12px;display:none" id="ytStopBtn" onclick="stopYTCapture()">‚èπ</button>
        </div>
      </div>

      <!-- Spotify / Apple Music note -->
      <div style="padding:0 20px;margin-bottom:14px">
        <div class="card" style="font-size:11px;color:var(--text3);line-height:1.6">
          For <strong style="color:var(--text2)">Spotify / Apple Music</strong>: these use DRM and require the System Audio tab + screen share. YouTube Music works natively here for free.
        </div>
      </div>

    </div>

    <!-- SYSTEM AUDIO CAPTURE PANEL -->
    <div class="source-panel" id="panel-capture">
      <div class="capture-panel">
        <div class="capture-icon-wrap">üéôÔ∏è</div>
        <div class="capture-title">System Audio Capture</div>
        <div class="capture-desc">Capture audio from any app playing on this device ‚Äî Spotify, Apple Music, YouTube, anything. SyncBeat relays it in real-time to all connected speakers.</div>

        <div class="capture-steps">
          <div class="capture-step">
            <div class="step-num">1</div>
            <div class="step-text">Click <strong>"Start Capture"</strong> below. Your browser will ask for screen share permission.</div>
          </div>
          <div class="capture-step">
            <div class="step-num">2</div>
            <div class="step-text">In the dialog, select <strong>your entire screen</strong> or a specific app window ‚Äî and make sure <strong>"Share system audio"</strong> is checked.</div>
          </div>
          <div class="capture-step">
            <div class="step-num">3</div>
            <div class="step-text">Open your music app (Spotify, Apple Music, etc.) and <strong>start playing</strong>. SyncBeat will relay it to all speakers automatically.</div>
          </div>
          <div class="capture-step">
            <div class="step-num">4</div>
            <div class="step-text"><strong>On iPhone/iPad:</strong> Use Screen Recording in Control Center, or use a Mac/PC as the host device for best results.</div>
          </div>
        </div>

        <div class="capture-status" id="captureStatus">
          <div class="cs-dot"></div>
          <span class="cs-text">Status: <span id="captureStatusText">Not capturing</span></span>
        </div>

        <div class="btn-row">
          <button class="btn btn-primary" id="startCaptureBtn" onclick="startSystemCapture()">üéôÔ∏è Start Capture</button>
          <button class="btn btn-ghost" id="stopCaptureBtn" onclick="stopSystemCapture()" style="display:none">‚èπ Stop</button>
        </div>
      </div>
    </div>

    <!-- Global Volume -->
    <div class="section">
      <div class="section-header">
        <span class="section-title">MASTER VOLUME</span>
        <span class="badge live" id="syncedCount">0 synced</span>
      </div>
      <div class="global-vol-card">
        <div class="global-vol-header">
          <span class="global-vol-title">ALL SPEAKERS</span>
          <span style="font-family:'DM Mono',monospace;font-size:10px;color:var(--accent3)" id="globalMuteLabel"></span>
        </div>
        <div class="volume-row">
          <svg class="vol-icon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>
          <div class="slider-wrap">
            <input type="range" min="0" max="100" value="80" id="globalVolume" oninput="setGlobalVolume(this.value)">
          </div>
          <span class="vol-value" id="globalVolumeVal">80</span>
          <div class="mute-btn" id="globalMuteBtn" onclick="toggleGlobalMute()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="var(--text2)"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg>
          </div>
        </div>
      </div>
    </div>

    <!-- Connected Speakers -->
    <div class="section">
      <div class="section-header">
        <span class="section-title">CONNECTED SPEAKERS</span>
        <span class="badge live" id="speakerCount">0 online</span>
      </div>
    </div>

    <div class="speakers-list" id="hostSpeakersList">
      <!-- Host card -->
      <div class="speaker-card me-spk">
        <div class="speaker-top">
          <div class="speaker-icon me-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="var(--accent3)"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14.5v-9l6 4.5-6 4.5z"/></svg>
          </div>
          <div class="speaker-info">
            <div class="speaker-name">This Device (Host)</div>
            <div class="speaker-sub">HOST ¬∑ MASTER</div>
          </div>
          <div class="speaker-status synced"></div>
        </div>
        <div class="volume-row">
          <svg class="vol-icon" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>
          <div class="slider-wrap">
            <input type="range" min="0" max="100" value="80" data-id="host" oninput="setSpeakerVolume('host',this.value,this)">
          </div>
          <span class="vol-value" id="vol-host">80</span>
          <div class="mute-btn" onclick="toggleSpeakerMute('host',this)">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="var(--text2)"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>
          </div>
        </div>
      </div>
    </div>

  </div><!-- end scroll -->

  <!-- Player Bar -->
  <div class="player-bar">
    <div class="now-playing">
      <div class="track-art" id="trackArt">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="var(--text3)"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
      </div>
      <div class="track-info">
        <div class="track-title" id="trackTitle">No source selected</div>
        <div class="track-source">
          <div class="source-dot" id="sourceDot" style="background:var(--text3)"></div>
          <span id="trackSource">Choose a source above</span>
        </div>
      </div>
      <div class="waveform paused" id="waveform">
        <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
        <div class="wave-bar"></div><div class="wave-bar"></div>
      </div>
    </div>

    <div class="progress-wrap" id="progressWrap" onclick="seekTrack(event)">
      <div class="progress-fill" id="progressFill" style="width:0%"></div>
      <div class="progress-thumb" id="progressThumb" style="left:0%"></div>
    </div>

    <div class="transport">
      <button class="transport-btn" onclick="prevTrack()">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
      </button>
      <button class="play-pause-btn" id="playPauseBtn" onclick="togglePlay()">
        <svg id="playIcon" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
      </button>
      <button class="transport-btn" onclick="nextTrack()">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
      </button>
    </div>
  </div>
</div>

<!-- =================== CLIENT SCREEN =================== -->
<div class="screen" id="clientScreen">
  <div class="scroll-area">

    <div class="section" style="margin-top:8px">
      <div class="room-code-display" style="text-align:left;display:flex;align-items:center;gap:14px">
        <div>
          <span class="room-code-label">Connected to Room</span>
          <span class="room-code" id="clientRoomCode" style="font-size:22px;letter-spacing:4px;display:block;margin:4px 0 0">------</span>
        </div>
        <div style="margin-left:auto;display:flex;flex-direction:column;align-items:flex-end;gap:4px">
          <div class="speaker-status synced" id="clientStatusDot" style="width:10px;height:10px"></div>
          <span class="latency" id="clientLatency">-- ms</span>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="card accent-border" style="font-size:12px;color:var(--text2);line-height:1.6">
        This device is a <strong style="color:var(--accent)">Speaker</strong>. Connect your Bluetooth speaker to this device. Audio will play automatically when the host streams music.
      </div>
    </div>

    <!-- My Volume -->
    <div class="section">
      <div class="section-title" style="margin-bottom:10px">MY SPEAKER VOLUME</div>
      <div class="global-vol-card">
        <div class="global-vol-header">
          <span class="global-vol-title" id="myClientName">Speaker</span>
          <span style="font-family:'DM Mono',monospace;font-size:10px;color:var(--accent3)">Local Control</span>
        </div>
        <div class="volume-row">
          <svg class="vol-icon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>
          <div class="slider-wrap">
            <input type="range" min="0" max="100" value="80" id="clientVolume" oninput="setClientVolume(this.value)">
          </div>
          <span class="vol-value" id="clientVolumeVal">80</span>
        </div>
      </div>
    </div>

    <!-- Now Playing -->
    <div class="section">
      <div class="section-title" style="margin-bottom:10px">NOW PLAYING</div>
      <div class="global-vol-card">
        <div style="display:flex;align-items:center;gap:12px">
          <div class="track-art" id="clientTrackArt" style="flex-shrink:0;font-size:22px"></div>
          <div style="flex:1;min-width:0">
            <div class="track-title" id="clientTrackTitle">Waiting for host...</div>
            <div class="track-source" style="margin-top:3px">
              <div class="source-dot" id="clientSourceDot" style="background:var(--text3)"></div>
              <span id="clientTrackStatus">Idle</span>
            </div>
          </div>
          <div class="waveform paused" id="clientWaveform">
            <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
            <div class="wave-bar"></div><div class="wave-bar"></div>
          </div>
        </div>
      </div>
    </div>

    <div style="padding:0 20px;margin-top:8px;padding-bottom:16px">
      <button class="btn btn-ghost btn-full" onclick="leaveSession()">Disconnect</button>
    </div>

  </div>
</div>

<!-- Hidden audio -->
<audio id="audioPlayer" preload="auto"></audio>

<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
<script>
// ========================= STATE =========================
const S = {
  mode: null,
  roomCode: null,
  isPlaying: false,
  currentTrack: -1,
  tracks: [],
  speakers: {},
  globalVolume: 80,
  globalMuted: false,
  hostVolume: 80,
  sourceMode: 'files',
  captureStream: null,
  captureSource: null,
  audioCtx: null,
  gainNode: null,
  engine: null,
  clientName: '',
};

const audio = document.getElementById('audioPlayer');

// ========================= SYNC ENGINE (PeerJS - real cross-device) =========================
class SyncEngine {
  constructor() {
    this.isHost = false;
    this.roomCode = null;
    this.handlers = {};
    this.clientId = 'sb-' + Math.random().toString(36).substr(2, 9);
    this.clockOffset = 0;
    this.peer = null;
    this.hostConn = null;
    this.clientConns = new Map();
    this.bc = null;
    this._pingTimers = [];
    this._connectedViaP2P = false;
  }

  genCode() {
    const c = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    return Array.from({length:6}, ()=>c[Math.floor(Math.random()*c.length)]).join('');
  }

  // ===== HOST =====
  async hostRoom() {
    this.isHost = true;
    this.roomCode = this.genCode();

    // BroadcastChannel (same browser, multiple tabs)
    this._setupBC();

    // PeerJS ‚Äî try multiple free servers in order
    const hostId = 'syncbeat-' + this.roomCode;
    const ok = await this._initPeer(hostId);

    if (ok && this.peer) {
      this.peer.on('connection', conn => {
        conn.on('open', () => {
          this.clientConns.set(conn.peer, conn);
          conn.on('data', data => this._handle(data, conn.peer));
          conn.on('close', () => {
            this.clientConns.delete(conn.peer);
            this._handleDisconnect(conn.peer);
          });
          conn.on('error', () => this.clientConns.delete(conn.peer));
        });
      });
      updateHostConnectionBadge(true);
    } else {
      // PeerJS unavailable ‚Äî host in BC-only mode
      updateHostConnectionBadge(false);
      showToast('‚ö† P2P unavailable ‚Äî same-device only');
    }
    return this.roomCode;
  }

  // ===== CLIENT =====
  async joinRoom(code) {
    this.isHost = false;
    this.roomCode = code;
    this._setupBC();

    // Show progress
    updateJoinStatus('Connecting to PeerJS...');

    const ok = await this._initPeer(this.clientId);

    if (!ok || !this.peer) {
      updateJoinStatus('PeerJS unavailable ‚Äî trying local...');
      // Last resort: BroadcastChannel only
      this._sendBC({type:'join', name:S.clientName, id:this.clientId});
      this._startClockSyncBC();
      return { method: 'bc-only' };
    }

    return new Promise((resolve, reject) => {
      updateJoinStatus('Looking up host...');

      const hostPeerId = 'syncbeat-' + code;
      let conn;
      try {
        conn = this.peer.connect(hostPeerId, {
          reliable: true,
          serialization: 'json',
          metadata: { name: S.clientName, id: this.clientId }
        });
        this.hostConn = conn;
      } catch(e) {
        reject(new Error('Could not initiate connection'));
        return;
      }

      // Timeout ‚Äî if PeerJS can't connect in 12s, fail clearly
      const timeout = setTimeout(() => {
        reject(new Error(
          'Could not reach host.

' +
          'Check that:
' +
          '‚Ä¢ Both devices are online
' +
          '‚Ä¢ Room code is correct
' +
          '‚Ä¢ Host session is still active'
        ));
      }, 12000);

      conn.on('open', () => {
        clearTimeout(timeout);
        this._connectedViaP2P = true;
        updateJoinStatus('Connected ‚úì');
        conn.on('data', data => this._handle(data, 'host'));
        conn.on('close', () => {
          this._connectedViaP2P = false;
          showToast('Disconnected from host');
          updateStatus('', 'offline');
        });
        conn.on('error', err => console.warn('conn error:', err));
        // Announce ourselves
        this._sendToHost({type:'join', name:S.clientName, id:this.clientId});
        this._startClockSync();
        resolve({ method: 'p2p' });
      });

      conn.on('error', err => {
        clearTimeout(timeout);
        const msg = err.type === 'peer-unavailable'
          ? 'Host not found. Make sure host is running and code is correct.'
          : 'Connection failed: ' + (err.message || err.type);
        reject(new Error(msg));
      });
    });
  }

  // ===== PEERJS INIT ‚Äî try multiple free servers =====
  async _initPeer(id) {
    if (typeof Peer === 'undefined') return false;

    // Try servers in order: PeerJS cloud, then backup
    const servers = [
      { host: '0.peerjs.com', port: 443, path: '/', secure: true },
      { host: 'peerjs.com', port: 443, path: '/myapp', secure: true },
    ];

    for (const srv of servers) {
      const result = await this._tryPeer(id, srv);
      if (result) return true;
    }
    return false;
  }

  _tryPeer(id, serverConfig) {
    return new Promise((resolve) => {
      const timeout = setTimeout(() => {
        try { if (this.peer) { this.peer.destroy(); this.peer = null; } } catch(e){}
        resolve(false);
      }, 7000);

      try {
        this.peer = new Peer(id, {
          ...serverConfig,
          debug: 0,
          config: {
            iceServers: [
              { urls: 'stun:stun.l.google.com:19302' },
              { urls: 'stun:stun1.l.google.com:19302' },
              { urls: 'stun:global.stun.twilio.com:3478' },
            ]
          }
        });

        this.peer.on('open', () => {
          clearTimeout(timeout);
          resolve(true);
        });

        this.peer.on('error', err => {
          clearTimeout(timeout);
          if (err.type === 'unavailable-id') {
            // ID taken ‚Äî generate a new one for client
            if (!this.isHost) {
              this.clientId = 'sb-' + Math.random().toString(36).substr(2, 9);
            }
            resolve(true); // Still connected, just ID conflict
            return;
          }
          try { this.peer.destroy(); this.peer = null; } catch(e){}
          resolve(false);
        });
      } catch(e) {
        clearTimeout(timeout);
        this.peer = null;
        resolve(false);
      }
    });
  }

  // ===== MESSAGING =====
  _setupBC() {
    try {
      this.bc = new BroadcastChannel('sb_' + this.roomCode);
      this.bc.onmessage = e => this._handle(e.data, 'bc');
    } catch(e) {}
  }

  _sendBC(data) {
    if (this.bc) try { this.bc.postMessage({...data, _from:this.clientId, _room:this.roomCode, _ts:Date.now()}); } catch(e){}
  }

  _sendToHost(data) {
    const msg = {...data, _from:this.clientId, _ts:Date.now()};
    if (this.hostConn && this.hostConn.open) try { this.hostConn.send(msg); } catch(e){}
    this._sendBC(msg);
  }

  _sendToAll(data) {
    const msg = {...data, _from:this.clientId, _ts:Date.now()};
    this.clientConns.forEach(conn => {
      if (conn.open) try { conn.send(msg); } catch(e){}
    });
    this._sendBC(msg);
  }

  broadcast(data) {
    if (this.isHost) this._sendToAll(data);
    else this._sendToHost(data);
  }

  _handle(data, source) {
    if (!data || data._from === this.clientId) return;
    if (data._room && data._room !== this.roomCode) return;
    // Host relays to all other clients
    if (this.isHost && source !== 'bc') {
      this.clientConns.forEach((conn, peerId) => {
        if (peerId !== source && conn.open) try { conn.send(data); } catch(e){}
      });
    }
    const h = this.handlers[data.type];
    if (h) h(data);
  }

  _handleDisconnect(peerId) {
    const spkEl = document.getElementById('spk-' + peerId);
    if (spkEl) {
      const name = spkEl.querySelector('.speaker-name')?.textContent || 'A speaker';
      showToast(name + ' disconnected');
      spkEl.remove();
      delete S.speakers[peerId];
      updateCounts();
    }
  }

  on(type, fn) { this.handlers[type] = fn; }

  // ===== CLOCK SYNC =====
  _startClockSync() {
    const samples = [];
    this.on('pong', d => {
      const rtt = Date.now() - d.t1;
      samples.push(rtt / 2);
      if (samples.length > 10) samples.shift();
      const sorted = [...samples].sort((a,b)=>a-b);
      this.clockOffset = sorted[Math.floor(sorted.length/2)];
      const el = document.getElementById('clientLatency');
      if (el) el.textContent = rtt + 'ms';
    });
    const t = setInterval(() => this._sendToHost({type:'ping', t1:Date.now()}), 3000);
    this._pingTimers.push(t);
    this._sendToHost({type:'ping', t1:Date.now()});
  }

  _startClockSyncBC() {
    this.on('pong', d => {
      const rtt = Date.now() - d.t1;
      const el = document.getElementById('clientLatency');
      if (el) el.textContent = rtt + 'ms';
    });
    const t = setInterval(() => this._sendBC({type:'ping', t1:Date.now()}), 3000);
    this._pingTimers.push(t);
  }

  destroy() {
    this._pingTimers.forEach(t => clearInterval(t));
    if (this.bc) try { this.bc.close(); } catch(e){}
    if (this.hostConn) try { this.hostConn.close(); } catch(e){}
    this.clientConns.forEach(c => { try { c.close(); } catch(e){} });
    if (this.peer) try { this.peer.destroy(); } catch(e){}
  }
}

// Host connection badge
function updateHostConnectionBadge(p2pReady) {
  const badge = document.getElementById('p2pBadge');
  if (!badge) return;
  if (p2pReady) {
    badge.textContent = 'üåê P2P Ready';
    badge.style.color = 'var(--accent3)';
    badge.style.borderColor = 'rgba(16,185,129,0.3)';
    badge.style.background = 'rgba(16,185,129,0.1)';
  } else {
    badge.textContent = '‚ö† Local only';
    badge.style.color = 'var(--warn)';
    badge.style.borderColor = 'rgba(245,158,11,0.3)';
    badge.style.background = 'rgba(245,158,11,0.1)';
  }
}

function updateJoinStatus(msg) {
  const el = document.getElementById('joinStatusMsg');
  if (el) el.textContent = msg;
}

// ========================= SOURCE TABS =========================
function setSourceTab(tab, el) {
  try {
    S.sourceMode = tab;
    const hostScreen = document.getElementById('hostScreen');
    hostScreen.querySelectorAll('.source-tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    hostScreen.querySelectorAll('.source-panel').forEach(p => {
      p.classList.remove('active');
      p.style.display = 'none';
    });
    const panel = document.getElementById('panel-' + tab);
    if (panel) {
      panel.classList.add('active');
      panel.style.display = 'block';
    } else {
      console.error('Panel not found: panel-' + tab);
    }

  if (tab === 'files') {
    updatePlayerSource('files');
  } else if (tab === 'capture') {
    updatePlayerSource('capture');
  }
}

function updatePlayerSource(mode) {
  const dot = document.getElementById('sourceDot');
  const src = document.getElementById('trackSource');
  if (mode === 'files') {
    dot.style.background = 'var(--accent)';
    src.textContent = 'Local Files';
    if (S.currentTrack >= 0) {
      document.getElementById('trackTitle').textContent = S.tracks[S.currentTrack]?.name.replace(/\.[^/.]+$/,'') || '';
    }
  } else if (mode === 'capture') {
    dot.style.background = 'var(--warn)';
    src.textContent = 'System Audio Capture';
    document.getElementById('trackTitle').textContent = 'System Audio';
  } else {
    dot.style.background = 'var(--accent3)';
  }
}

// ========================= YOUTUBE MUSIC PLAYER =========================
const YT_STATE = {
  videoId: null,
  capturing: false,
  captureStream: null,
  captureSource: null,
};

// Use YouTube IFrame API via embed ‚Äî works cross-origin without screen share
// Audio capture uses getDisplayMedia targeting the iframe via AudioContext

function ytSearch() {
  const q = document.getElementById('ytSearchInput').value.trim();
  if (!q) return;
  ytFetch(q);
}

function ytQuick(q) {
  document.getElementById('ytSearchInput').value = q;
  ytFetch(q);
}

async function ytFetch(query) {
  const loading = document.getElementById('ytLoading');
  const results = document.getElementById('ytResults');
  loading.classList.add('visible');
  results.classList.remove('visible');
  results.innerHTML = '';

  try {
    const instances = [
      'https://inv.tux.pizza',
      'https://iv.datura.network',
      'https://invidious.slipfox.xyz',
      'https://invidious.nerdvpn.de',
      'https://invidious.privacydev.net',
    ];
    
    let data = null;
    for (const inst of instances) {
      try {
        const r = await fetch(`${inst}/api/v1/search?q=${encodeURIComponent(query)}&type=video&fields=videoId,title,author,lengthSeconds,videoThumbnails`, {signal: AbortSignal.timeout(5000)});
        if (r.ok) { data = await r.json(); break; }
      } catch(e) { continue; }
    }

    loading.classList.remove('visible');

    if (!data || !data.length) {
      // Fallback: direct YouTube search via embed trick
      ytFallbackSearch(query);
      return;
    }

    results.innerHTML = '';
    const items = data.slice(0, 8);
    items.forEach(v => {
      const thumb = v.videoThumbnails?.[3]?.url || v.videoThumbnails?.[0]?.url || '';
      const dur = v.lengthSeconds ? formatDur(v.lengthSeconds) : '';
      const item = document.createElement('div');
      item.className = 'yt-result-item';
      item.innerHTML = `
        <img class="yt-result-thumb" src="${thumb}" onerror="this.style.background='var(--surface2)';this.src=''">
        <div class="yt-result-info">
          <div class="yt-result-title">${escHtml(v.title)}</div>
          <div class="yt-result-ch">${escHtml(v.author||'')} ${dur ? '¬∑ ' + dur : ''}</div>
        </div>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="var(--accent2)"><path d="M8 5v14l11-7z"/></svg>
      `;
      item.onclick = () => ytPlay(v.videoId, v.title, v.author);
      results.appendChild(item);
    });
    results.classList.add('visible');

  } catch(e) {
    loading.classList.remove('visible');
    ytFallbackSearch(query);
  }
}

function ytFallbackSearch(query) {
  // Show a direct link option when API is unreachable
  const results = document.getElementById('ytResults');
  results.innerHTML = `
    <div style="padding:12px;font-size:12px;color:var(--text2);line-height:1.6">
      <div style="margin-bottom:8px">API unavailable. Enter a YouTube video ID or URL directly:</div>
      <div style="display:flex;gap:8px">
        <input id="ytDirectInput" class="yt-search-input" style="flex:1" placeholder="Video ID or YouTube URL" oninput="" />
        <button class="yt-search-btn" onclick="ytPlayDirect()">‚ñ∂</button>
      </div>
      <div style="margin-top:8px;font-size:11px;color:var(--text3)">
        Example: open YouTube Music, copy the video ID from the URL (the part after v=), paste it here.
      </div>
    </div>
  `;
  results.classList.add('visible');
}

function ytPlayDirect() {
  const val = document.getElementById('ytDirectInput')?.value?.trim();
  if (!val) return;
  // Extract video ID from URL or use directly
  let id = val;
  const match = val.match(/(?:v=|youtu\.be\/|embed\/)([\w-]{11})/);
  if (match) id = match[1];
  if (id.length === 11) ytPlay(id, 'YouTube Video', '');
  else showToast('Invalid video ID');
}

function ytPlay(videoId, title, channel) {
  YT_STATE.videoId = videoId;
  
  // Load in iframe
  const wrap = document.getElementById('ytIframeWrap');
  const iframe = document.getElementById('ytIframe');
  
  // autoplay=1, enablejsapi=1 for maximum compatibility
  iframe.src = `https://www.youtube-nocookie.com/embed/${videoId}?autoplay=1&rel=0&modestbranding=1&enablejsapi=1&origin=${encodeURIComponent(location.origin)}`;
  
  wrap.classList.add('visible');
  document.getElementById('ytResults').classList.remove('visible');
  
  // Update player bar
  document.getElementById('trackTitle').textContent = title || 'YouTube Music';
  document.getElementById('trackSource').textContent = channel || 'YouTube';
  document.getElementById('sourceDot').style.background = '#ff0000';
  document.getElementById('trackArt').innerHTML = '‚ñ∂Ô∏è';
  document.getElementById('trackArt').classList.add('playing');
  document.getElementById('waveform').classList.remove('paused');
  S.isPlaying = true;
  setPlayIcon(true);

  // Notify clients
  if (S.engine) {
    S.engine.broadcast({
      type: 'ytPlay',
      videoId,
      title: title || 'YouTube Music',
      channel: channel || 'YouTube',
    });
  }

  showToast('‚ñ∂ Playing ¬∑ tap Capture Audio to sync speakers');
}

async function startYTCapture() {
  // For the YouTube iframe, we capture the tab audio using getDisplayMedia
  // On Chrome desktop: user selects "This Tab" ‚Äî no full screen share needed
  // On mobile: falls back to system audio capture
  
  if (typeof navigator.mediaDevices?.getDisplayMedia === 'undefined') {
    showToast('Audio capture not supported on this browser');
    return;
  }

  try {
    const stream = await navigator.mediaDevices.getDisplayMedia({
      video: true,
      audio: {
        echoCancellation: false,
        noiseSuppression: false,
        sampleRate: 44100,
        channelCount: 2,
      },
      preferCurrentTab: true, // Chrome hint ‚Äî auto-selects current tab!
    });

    const audioTracks = stream.getAudioTracks();
    if (audioTracks.length === 0) {
      stream.getTracks().forEach(t=>t.stop());
      showToast('No audio ‚Äî check "Share tab audio" in dialog');
      return;
    }

    // Stop video ‚Äî audio only
    stream.getVideoTracks().forEach(t => t.stop());

    if (!S.audioCtx) S.audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 44100 });
    if (S.audioCtx.state === 'suspended') await S.audioCtx.resume();

    YT_STATE.captureStream = new MediaStream(audioTracks);
    YT_STATE.captureSource = S.audioCtx.createMediaStreamSource(YT_STATE.captureStream);

    S.gainNode = S.audioCtx.createGain();
    S.gainNode.gain.value = (S.hostVolume / 100) * (S.globalVolume / 100);

    YT_STATE.captureSource.connect(S.gainNode);
    S.gainNode.connect(S.audioCtx.destination);
    YT_STATE.capturing = true;

    // Update UI
    document.getElementById('ytCaptureStatus').textContent = '‚úì Capturing ‚Äî all speakers in sync';
    document.getElementById('ytCaptureStatus').classList.add('active');
    document.getElementById('ytCaptureBtn').style.display = 'none';
    document.getElementById('ytStopBtn').style.display = '';

    audioTracks[0].addEventListener('ended', stopYTCapture);

    if (S.engine) {
      S.engine.broadcast({
        type: 'captureStart',
        trackName: document.getElementById('trackTitle').textContent,
        source: 'youtube',
        volume: S.globalVolume,
      });
    }

    showToast('üéôÔ∏è YouTube audio captured ‚Äî all speakers synced!');

  } catch(err) {
    if (err.name === 'NotAllowedError') showToast('Permission denied');
    else showToast('Capture error: ' + err.message);
  }
}

function stopYTCapture() {
  if (YT_STATE.captureStream) { YT_STATE.captureStream.getTracks().forEach(t=>t.stop()); YT_STATE.captureStream = null; }
  if (YT_STATE.captureSource) { try{YT_STATE.captureSource.disconnect()}catch(e){} YT_STATE.captureSource = null; }
  YT_STATE.capturing = false;
  document.getElementById('ytCaptureStatus').textContent = 'Audio not captured yet';
  document.getElementById('ytCaptureStatus').classList.remove('active');
  document.getElementById('ytCaptureBtn').style.display = '';
  document.getElementById('ytStopBtn').style.display = 'none';
  showToast('Capture stopped');
}

function formatDur(s) {
  const m = Math.floor(s/60), sec = s%60;
  return `${m}:${sec.toString().padStart(2,'0')}`;
}

function closeModal() {
  document.getElementById('captureModal').classList.remove('show');
}
document.getElementById('captureModal').addEventListener('click', e => {
  if (e.target === document.getElementById('captureModal')) closeModal();
});

// ========================= SYSTEM AUDIO CAPTURE =========================
async function startSystemCapture() {
  try {
    // Request screen/tab/window capture with audio
    const displayStream = await navigator.mediaDevices.getDisplayMedia({
      video: true,
      audio: {
        echoCancellation: false,
        noiseSuppression: false,
        sampleRate: 44100,
        channelCount: 2,
      }
    });

    const audioTracks = displayStream.getAudioTracks();

    if (audioTracks.length === 0) {
      showToast('‚ö† No audio track ‚Äî make sure "Share audio" is checked');
      displayStream.getTracks().forEach(t=>t.stop());
      return;
    }

    // Stop video tracks (we only need audio)
    displayStream.getVideoTracks().forEach(t => t.stop());

    // Set up AudioContext to pipe captured audio to speakers + relay
    if (!S.audioCtx) {
      S.audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 44100 });
    }

    S.captureStream = new MediaStream(audioTracks);
    S.captureSource = S.audioCtx.createMediaStreamSource(S.captureStream);

    // Create gain node for volume control
    S.gainNode = S.audioCtx.createGain();
    S.gainNode.gain.value = S.hostVolume / 100;

    // Connect: capture ‚Üí gain ‚Üí output (plays locally)
    S.captureSource.connect(S.gainNode);
    S.gainNode.connect(S.audioCtx.destination);

    // Update UI
    document.getElementById('captureStatus').classList.add('active');
    document.getElementById('captureStatusText').textContent = 'Capturing system audio ‚úì';
    document.getElementById('startCaptureBtn').style.display = 'none';
    document.getElementById('stopCaptureBtn').style.display = '';

    // Update player bar
    document.getElementById('trackTitle').textContent = 'System Audio';
    document.getElementById('trackSource').textContent = 'Live Capture';
    document.getElementById('sourceDot').style.background = 'var(--accent3)';
    document.getElementById('waveform').classList.remove('paused');
    document.getElementById('trackArt').classList.add('playing');
    document.getElementById('trackArt').innerHTML = '<span style="position:relative;z-index:1">üéôÔ∏è</span>';
    S.isPlaying = true;
    setPlayIcon(true);

    // Handle stream ending (user stops sharing)
    audioTracks[0].addEventListener('ended', () => {
      stopSystemCapture();
    });

    // Notify clients
    if (S.engine) {
      S.engine.broadcast({
        type: 'captureStart',
        trackName: 'System Audio (Live)',
        source: 'system',
        volume: S.globalVolume
      });
    }

    showToast('üéôÔ∏è Capturing system audio');

  } catch(err) {
    if (err.name === 'NotAllowedError') {
      showToast('Permission denied ‚Äî please allow screen share');
    } else if (err.name === 'NotSupportedError') {
      showToast('Not supported on this browser/device');
    } else {
      showToast('Could not start capture: ' + err.message);
    }
    console.error(err);
  }
}

function stopSystemCapture() {
  if (S.captureStream) {
    S.captureStream.getTracks().forEach(t=>t.stop());
    S.captureStream = null;
  }
  if (S.captureSource) {
    try { S.captureSource.disconnect(); } catch(e){}
    S.captureSource = null;
  }

  document.getElementById('captureStatus').classList.remove('active');
  document.getElementById('captureStatusText').textContent = 'Not capturing';
  document.getElementById('startCaptureBtn').style.display = '';
  document.getElementById('stopCaptureBtn').style.display = 'none';
  document.getElementById('waveform').classList.add('paused');
  document.getElementById('trackArt').classList.remove('playing');
  document.getElementById('trackArt').innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="var(--text3)"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>';

  S.isPlaying = false;
  setPlayIcon(false);
  if (S.engine) S.engine.broadcast({type:'pause'});
  showToast('Capture stopped');
}

// ========================= HOST SETUP =========================
function showHostSetup() {
  startHost();
}

async function startHost() {
  // Show loading state on button
  const hostBtn = document.querySelector('#homeScreen .btn-primary');
  if (hostBtn) { hostBtn.textContent = 'Starting...'; hostBtn.disabled = true; }

  S.engine = new SyncEngine();
  S.mode = 'host';

  S.engine.on('join', data => {
    addSpeaker(data.id, data.name);
    setTimeout(() => {
      S.engine.broadcast({
        type: 'state',
        trackName: S.currentTrack >= 0 ? S.tracks[S.currentTrack]?.name.replace(/\.[^/.]+$/,'') : '',
        isPlaying: S.isPlaying,
        currentTime: audio.currentTime,
        volume: S.globalVolume,
        sourceMode: S.sourceMode,
      });
    }, 400);
  });

  S.engine.on('ping', data => {
    S.engine.broadcast({type:'pong', t1:data.t1, t2:Date.now(), t3:Date.now()});
  });

  S.engine.on('volumeChange', data => {
    if (S.speakers[data.id]) S.speakers[data.id].volume = data.volume;
  });

  const code = await S.engine.hostRoom();
  S.roomCode = code;
  document.getElementById('displayRoomCode').textContent = code;
  showScreen('hostScreen');
  updateStatus('hosting', 'hosting');
  if (hostBtn) { hostBtn.textContent = 'üéµ Host Session'; hostBtn.disabled = false; }
  const peerReady = S.engine.peer && !S.engine.peer.destroyed;
  if (peerReady) {
    showToast('‚úì Session live! Share your room code');
  } else {
    showToast('‚ö† P2P offline ‚Äî only same-device tabs can join');
  }
}

function addSpeaker(id, name) {
  if (S.speakers[id]) return;
  S.speakers[id] = {name, volume:80, muted:false};
  renderSpeakers();
  updateCounts();
  showToast(`${name} joined`);
}

function renderSpeakers() {
  const list = document.getElementById('hostSpeakersList');
  const hostCard = list.firstElementChild;
  while(list.children.length > 1) list.removeChild(list.lastChild);

  Object.entries(S.speakers).forEach(([id,spk]) => {
    const card = document.createElement('div');
    card.className = 'speaker-card active-spk';
    card.id = `spk-${id}`;
    card.innerHTML = `
      <div class="speaker-top">
        <div class="speaker-icon client">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="var(--accent2)"><path d="M17 12h-5v5h5v-5zM16 1v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-1V1h-2zm3 18H5V8h14v11z"/></svg>
        </div>
        <div class="speaker-info">
          <div class="speaker-name">${escHtml(spk.name)}</div>
          <div class="speaker-sub">SPEAKER ¬∑ CLIENT</div>
        </div>
        <div class="speaker-status synced"></div>
      </div>
      <div class="volume-row">
        <svg class="vol-icon" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>
        <div class="slider-wrap">
          <input type="range" min="0" max="100" value="${spk.volume}" data-id="${id}"
            oninput="setSpeakerVolume('${id}',this.value,this)">
        </div>
        <span class="vol-value" id="vol-${id}">${spk.volume}</span>
        <div class="mute-btn" onclick="toggleSpeakerMute('${id}',this)">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="var(--text2)"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>
        </div>
      </div>
    `;
    list.appendChild(card);
  });
}

function updateCounts() {
  const n = Object.keys(S.speakers).length;
  document.getElementById('speakerCount').textContent = `${n} online`;
  document.getElementById('syncedCount').textContent = `${n} synced`;
}

// ========================= CLIENT LOGIC =========================
function showJoin() { showScreen('joinScreen'); }

async function joinSession() {
  const code = document.getElementById('roomCodeInput').value.trim();
  const name = document.getElementById('clientNameInput').value.trim() || 'Speaker';
  if (code.length < 4) { showToast('Enter a valid room code'); return; }

  S.clientName = name;
  S.engine = new SyncEngine();
  S.mode = 'client';

  S.engine.on('state', d => {
    document.getElementById('clientTrackTitle').textContent = d.trackName || 'Waiting...';
    if (d.isPlaying) {
      document.getElementById('clientWaveform').classList.remove('paused');
      document.getElementById('clientTrackStatus').textContent = 'Playing';
      document.getElementById('clientSourceDot').style.background = 'var(--accent3)';
    }
    audio.volume = (d.volume||80)/100;
    document.getElementById('clientVolume').value = d.volume||80;
    document.getElementById('clientVolumeVal').textContent = d.volume||80;
  });

  S.engine.on('play', d => {
    if(d.src){audio.src=d.src;audio.load();}
    audio.currentTime = d.time||0;
    audio.volume = (d.volume||80)/100;
    audio.play().catch(()=>{
      showToast('Tap to enable audio');
      document.addEventListener('click',()=>audio.play(),{once:true});
    });
    document.getElementById('clientWaveform').classList.remove('paused');
    document.getElementById('clientTrackStatus').textContent='Playing';
    document.getElementById('clientTrackTitle').textContent=d.trackName||'Playing';
    document.getElementById('clientSourceDot').style.background='var(--accent)';
  });

  S.engine.on('captureStart', d => {
    document.getElementById('clientTrackTitle').textContent = d.trackName||'System Audio';
    document.getElementById('clientTrackStatus').textContent = 'Live ¬∑ synced';
    document.getElementById('clientSourceDot').style.background = 'var(--accent3)';
    document.getElementById('clientWaveform').classList.remove('paused');
    document.getElementById('clientTrackArt').innerHTML = d.source === 'youtube' ? '‚ñ∂Ô∏è' : 'üéôÔ∏è';
    showToast('Host started streaming');
  });

  S.engine.on('ytPlay', d => {
    document.getElementById('clientTrackTitle').textContent = d.title || 'YouTube Music';
    document.getElementById('clientTrackStatus').textContent = (d.channel || 'YouTube') + ' ¬∑ waiting for host capture';
    document.getElementById('clientSourceDot').style.background = '#ff0000';
    document.getElementById('clientTrackArt').innerHTML = '‚ñ∂Ô∏è';
    document.getElementById('clientWaveform').classList.remove('paused');
  });

  S.engine.on('pause', () => {
    audio.pause();
    document.getElementById('clientWaveform').classList.add('paused');
    document.getElementById('clientTrackStatus').textContent='Paused';
  });

  S.engine.on('seek', d => { audio.currentTime=d.time; });

  S.engine.on('volumeSet', d => {
    if(d.targetId===S.engine.clientId||d.targetId==='all'){
      const v=d.volume/100;
      audio.volume=v;
      document.getElementById('clientVolume').value=d.volume;
      document.getElementById('clientVolumeVal').textContent=d.volume;
    }
  });

  S.engine.on('trackInfo', d => {
    document.getElementById('clientTrackTitle').textContent=d.name;
  });

  // Show connecting state
  const joinBtn = document.getElementById('joinConnectBtn');
  if (joinBtn) { joinBtn.textContent = 'Connecting...'; joinBtn.disabled = true; }

  try {
    await S.engine.joinRoom(code);
    document.getElementById('clientRoomCode').textContent = code;
    document.getElementById('myClientName').textContent = name;
    showScreen('clientScreen');
    updateStatus('online','synced');
    showToast(`Joined room ${code}`);
  } catch(err) {
    if (S.engine) { S.engine.destroy(); S.engine = null; }
    S.mode = null;
    const msg = err.message || 'Could not connect';
    const firstLine = msg.split('\n')[0];
    showToast('‚úó ' + firstLine);
    updateJoinStatus(firstLine);
    console.error('Join error:', msg);
  } finally {
    if (joinBtn) { joinBtn.textContent = 'Connect ‚Üí'; joinBtn.disabled = false; }
  }
}

function setClientVolume(val) {
  document.getElementById('clientVolumeVal').textContent = val;
  audio.volume = val/100;
  if(S.engine) S.engine.broadcast({type:'volumeChange',id:S.engine.clientId,volume:parseInt(val)});
}

function leaveSession() {
  if(S.engine){S.engine.destroy();S.engine=null;}
  audio.pause(); audio.src='';
  S.mode=null;
  showScreen('homeScreen');
  updateStatus('','offline');
}

// ========================= FILES PLAYBACK =========================
function handleFiles(e) {
  const files = Array.from(e.target.files).filter(f=>f.type.startsWith('audio/'));
  files.forEach(f=>S.tracks.push({name:f.name, url:URL.createObjectURL(f)}));
  renderFileList();
  document.getElementById('trackCount') && (document.getElementById('trackCount').textContent=`${S.tracks.length} tracks`);
  if(S.tracks.length>0&&S.currentTrack===-1) loadTrack(0,false);
  showToast(`${files.length} track${files.length>1?'s':''} added`);
}

function renderFileList() {
  const list = document.getElementById('fileList');
  list.innerHTML='';
  S.tracks.forEach((t,i)=>{
    const item=document.createElement('div');
    item.className='file-item'+(i===S.currentTrack?' playing':'');
    item.innerHTML=`
      <svg width="14" height="14" viewBox="0 0 24 24" fill="${i===S.currentTrack?'var(--accent)':'var(--text3)'}">
        <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
      </svg>
      <span class="file-name">${escHtml(t.name.replace(/\.[^/.]+$/,''))}</span>
    `;
    item.onclick=()=>loadTrack(i,true);
    list.appendChild(item);
  });
}

function loadTrack(idx, play) {
  if(idx<0||idx>=S.tracks.length) return;
  S.currentTrack=idx;
  const t=S.tracks[idx];
  audio.src=t.url;
  audio.volume=S.hostVolume/100;
  const name=t.name.replace(/\.[^/.]+$/,'');
  document.getElementById('trackTitle').textContent=name;
  document.getElementById('trackSource').textContent='Local File';
  document.getElementById('sourceDot').style.background='var(--accent)';
  document.getElementById('trackArt').innerHTML='<svg width="18" height="18" viewBox="0 0 24 24" fill="var(--text3)"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>';
  document.getElementById('trackArt').classList.remove('playing');
  renderFileList();
  if(play){
    audio.load();
    audio.play().then(()=>onPlay()).catch(console.warn);
  }
}

function togglePlay() {
  if(S.sourceMode==='capture'){
    showToast('Use the System Audio tab to control capture');
    return;
  }
  if(!S.tracks.length){showToast('Upload music first');return;}
  if(S.currentTrack===-1){loadTrack(0,true);return;}
  if(audio.paused) audio.play().then(onPlay).catch(console.warn);
  else {audio.pause();onPause();}
}

function onPlay() {
  S.isPlaying=true;
  setPlayIcon(true);
  document.getElementById('waveform').classList.remove('paused');
  document.getElementById('trackArt').classList.add('playing');
  if(S.engine) S.engine.broadcast({
    type:'play', time:audio.currentTime,
    trackName:S.tracks[S.currentTrack]?.name.replace(/\.[^/.]+$/,'')||'',
    volume:S.globalVolume,
  });
}

function onPause() {
  S.isPlaying=false;
  setPlayIcon(false);
  document.getElementById('waveform').classList.add('paused');
  document.getElementById('trackArt').classList.remove('playing');
  if(S.engine) S.engine.broadcast({type:'pause'});
}

function setPlayIcon(playing) {
  document.getElementById('playIcon').innerHTML = playing
    ? '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>'
    : '<path d="M8 5v14l11-7z"/>';
}

audio.addEventListener('ended',()=>nextTrack());
audio.addEventListener('timeupdate',()=>{
  if(!audio.duration) return;
  const pct=(audio.currentTime/audio.duration)*100;
  document.getElementById('progressFill').style.width=pct+'%';
  document.getElementById('progressThumb').style.left=pct+'%';
});

function seekTrack(e) {
  if(!audio.duration) return;
  const r=e.currentTarget.getBoundingClientRect();
  audio.currentTime=((e.clientX-r.left)/r.width)*audio.duration;
  if(S.engine) S.engine.broadcast({type:'seek',time:audio.currentTime});
}

function prevTrack(){
  if(S.tracks.length===0)return;
  loadTrack(S.currentTrack>0?S.currentTrack-1:S.tracks.length-1, S.isPlaying);
}
function nextTrack(){
  if(S.tracks.length===0)return;
  loadTrack((S.currentTrack+1)%S.tracks.length, true);
}

// ========================= VOLUME =========================
function setGlobalVolume(val) {
  const v=parseInt(val);
  S.globalVolume=v;
  document.getElementById('globalVolumeVal').textContent=v;
  audio.volume=(S.hostVolume/100)*(v/100);
  if(S.gainNode) S.gainNode.gain.value=(S.hostVolume/100)*(v/100);
  if(S.engine) S.engine.broadcast({type:'volumeSet',targetId:'all',volume:v});
}

function setSpeakerVolume(id,val,el) {
  const v=parseInt(val);
  document.getElementById(`vol-${id}`).textContent=v;
  if(id==='host'){
    S.hostVolume=v;
    audio.volume=(v/100)*(S.globalVolume/100);
    if(S.gainNode) S.gainNode.gain.value=(v/100)*(S.globalVolume/100);
  } else if(S.speakers[id]){
    S.speakers[id].volume=v;
    if(S.engine) S.engine.broadcast({type:'volumeSet',targetId:id,volume:v});
  }
}

function toggleGlobalMute() {
  S.globalMuted=!S.globalMuted;
  document.getElementById('globalMuteBtn').classList.toggle('muted',S.globalMuted);
  document.getElementById('globalMuteLabel').textContent=S.globalMuted?'MUTED':'';
  audio.muted=S.globalMuted;
  if(S.gainNode) S.gainNode.gain.value=S.globalMuted?0:(S.hostVolume/100)*(S.globalVolume/100);
  if(S.engine) S.engine.broadcast({type:'volumeSet',targetId:'all',volume:S.globalMuted?0:S.globalVolume});
}

function toggleSpeakerMute(id,el) {
  if(id==='host'){
    audio.muted=!audio.muted;
    el.classList.toggle('muted',audio.muted);
  } else if(S.speakers[id]){
    S.speakers[id].muted=!S.speakers[id].muted;
    el.classList.toggle('muted',S.speakers[id].muted);
    if(S.engine) S.engine.broadcast({type:'volumeSet',targetId:id,volume:S.speakers[id].muted?0:S.speakers[id].volume});
  }
}

// ========================= UTILS =========================
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function goHome(){
  if(S.captureStream) stopSystemCapture();
  if(S.engine){S.engine.destroy();S.engine=null;}
  audio.pause();audio.src='';
  S.mode=null;S.isPlaying=false;S.tracks=[];S.currentTrack=-1;S.speakers={};
  showScreen('homeScreen');
  updateStatus('','offline');
}

function updateStatus(dotClass,label){
  document.getElementById('statusDot').className='status-dot '+dotClass;
  document.getElementById('statusLabel').textContent=label;
}

function copyRoomCode(){
  navigator.clipboard.writeText(S.roomCode||'').then(()=>showToast('Code copied!')).catch(()=>showToast(`Code: ${S.roomCode}`));
}

let toastTimer=null;
function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg;t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>t.classList.remove('show'),2600);
}

function escHtml(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}

// Drag & Drop
const ua=document.getElementById('uploadArea');
ua.addEventListener('dragover',e=>{e.preventDefault();ua.classList.add('drag')});
ua.addEventListener('dragleave',()=>ua.classList.remove('drag'));
ua.addEventListener('drop',e=>{
  e.preventDefault();ua.classList.remove('drag');
  const files=Array.from(e.dataTransfer.files).filter(f=>f.type.startsWith('audio/'));
  if(files.length){
    const dt=new DataTransfer();files.forEach(f=>dt.items.add(f));
    handleFiles({target:{files:dt.files}});
  }
});

// iOS AudioContext unlock
document.addEventListener('touchstart',()=>{
  if(S.audioCtx&&S.audioCtx.state==='suspended') S.audioCtx.resume();
},{passive:true});

updateStatus('','offline');
</script>
</body>
</html>
